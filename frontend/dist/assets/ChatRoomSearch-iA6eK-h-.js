import{_ as ve,u as fe,j as ge,o as c,c as g,a as d,b as t,w as l,y as he,s as ye,e as z,m as k,l as h,f as p,r as i,q as be,i as q,g as we,v as L,z as Ve,h as m,A as ke,F as H,n as K,d as M,t as _,B as Ce}from"./index-BpwqB7Vr.js";const xe={class:"chat-room-search"},Re={class:"search-header"},Ue={class:"search-form"},De={class:"search-results"},Ie={key:0,class:"no-results"},ze={key:1},Ae={class:"room-header"},Fe={class:"room-avatar"},Se={class:"room-info"},$e={class:"room-name"},Be={class:"room-id"},je={key:0,class:"room-description"},Je={class:"room-stats"},qe={class:"member-count"},Le={class:"room-actions"},Me={key:0,class:"pagination"},Ne={key:0,class:"join-room-info"},Ge={class:"room-header"},Pe={class:"room-info"},O="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",N=20,Ee={__name:"ChatRoomSearch",setup(Te){const A=we(),F=fe(),v=q({chatId:"",keyword:""}),b=p([]),I=p(!1),w=p(0),C=p(1),x=p(!1),S=p(!1),R=p(),$=p([]),n=q({name:"",description:"",avatar_url:"",max_members:500,is_public:!0,group_id:null}),Q={name:[{required:!0,message:"请输入群聊名称",trigger:"blur"},{min:1,max:100,message:"群聊名称长度不能超过100个字符",trigger:"blur"}]},U=p(!1),B=p(!1),y=p(null),D=q({message:""}),j=o=>{if(!o||o.length<=4)return o;let e="";for(let r=0;r<o.length;r++)r>0&&r%3===0&&(e+="-"),e+=o[r];return e},V=async()=>{var o,e,r;I.value=!0;try{const s={page:C.value,page_size:N};if(v.chatId)try{const u=await k.chatRooms.searchByChatId(v.chatId);b.value=[u.data],w.value=1}catch(u){if(((o=u.response)==null?void 0:o.status)===404)b.value=[],w.value=0,h.warning("未找到该群聊ID");else throw u}else if(v.keyword){s.keyword=v.keyword;const u=await k.chatRooms.searchChatRooms(s);b.value=u.data.chat_rooms,w.value=u.data.total}else{const u=await k.chatRooms.searchChatRooms(s);b.value=u.data.chat_rooms,w.value=u.data.total}}catch(s){h.error("搜索失败："+(((r=(e=s.response)==null?void 0:e.data)==null?void 0:r.detail)||s.message))}finally{I.value=!1}},W=()=>{v.chatId="",v.keyword="",C.value=1,V()},X=o=>{C.value=o,V()},Y=async()=>{try{const o=await k.groups.getGroups();$.value=[...o.data.created.map(e=>({...e,isCreated:!0})),...o.data.joined.map(e=>({...e,isJoined:!0}))]}catch(o){console.error("获取用户群组失败:",o)}},Z=async()=>{if(!F.isAuthenticated){h.warning("请先登录后再创建群聊"),A.push("/login");return}R.value&&await R.value.validate(async o=>{var e,r;if(o){S.value=!0;try{const s=await k.chatRooms.createChatRoom(n);h.success("群聊创建成功！"),h.info(`群聊ID: ${j(s.data.chat_id)}`),x.value=!1,G(),V()}catch(s){h.error("创建失败："+(((r=(e=s.response)==null?void 0:e.data)==null?void 0:r.detail)||s.message))}finally{S.value=!1}}})},G=()=>{n.name="",n.description="",n.avatar_url="",n.max_members=500,n.is_public=!0,n.group_id=null,R.value&&R.value.clearValidate()},P=o=>(F.isAuthenticated,!1),ee=o=>{if(!F.isAuthenticated){h.warning("请先登录后再加入群聊"),A.push("/login");return}y.value=o,U.value=!0},ae=async()=>{var o,e;B.value=!0;try{await k.chatRooms.createJoinRequest(y.value.chat_room_id,{message:D.message}),h.success("加入申请已发送，请等待审批"),U.value=!1,D.message=""}catch(r){h.error("申请失败："+(((e=(o=r.response)==null?void 0:o.data)==null?void 0:e.detail)||r.message))}finally{B.value=!1}},te=o=>{A.push(`/chat-rooms/${o.chat_room_id}`)};return ge(async()=>{await Y(),V()}),(o,e)=>{const r=i("el-icon"),s=i("el-button"),u=i("el-input"),f=i("el-form-item"),J=i("el-form"),le=i("el-empty"),E=i("el-avatar"),oe=i("el-tag"),se=i("el-card"),ne=i("el-col"),re=i("el-row"),ue=i("el-pagination"),de=i("el-input-number"),ie=i("el-switch"),me=i("el-option"),ce=i("el-select"),T=i("el-dialog"),pe=be("loading");return c(),g("div",xe,[d("div",Re,[e[16]||(e[16]=d("h2",null,"搜索群聊",-1)),t(s,{type:"primary",onClick:e[0]||(e[0]=a=>x.value=!0)},{default:l(()=>[t(r,null,{default:l(()=>[t(L(Ve))]),_:1}),e[15]||(e[15]=m(" 创建群聊 ",-1))]),_:1})]),d("div",Ue,[t(J,{inline:!0,onSubmit:he(V,["prevent"])},{default:l(()=>[t(f,{label:"群聊ID"},{default:l(()=>[t(u,{modelValue:v.chatId,"onUpdate:modelValue":e[1]||(e[1]=a=>v.chatId=a),placeholder:"输入6-8位群聊ID",maxlength:"8",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),t(f,{label:"关键词"},{default:l(()=>[t(u,{modelValue:v.keyword,"onUpdate:modelValue":e[2]||(e[2]=a=>v.keyword=a),placeholder:"群聊名称或描述",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),t(f,null,{default:l(()=>[t(s,{type:"primary",onClick:V,loading:I.value},{default:l(()=>[t(r,null,{default:l(()=>[t(L(ke))]),_:1}),e[17]||(e[17]=m(" 搜索 ",-1))]),_:1},8,["loading"]),t(s,{onClick:W},{default:l(()=>[...e[18]||(e[18]=[m("重置",-1)])]),_:1})]),_:1})]),_:1})]),ye((c(),g("div",De,[b.value.length===0?(c(),g("div",Ie,[t(le,{description:"暂无搜索结果"})])):(c(),g("div",ze,[t(re,{gutter:20},{default:l(()=>[(c(!0),g(H,null,K(b.value,a=>(c(),M(ne,{xs:24,sm:12,md:8,lg:6,key:a.chat_room_id},{default:l(()=>[t(se,{class:"chat-room-card",shadow:"hover"},{default:l(()=>[d("div",Ae,[d("div",Fe,[t(E,{size:50,src:a.avatar_url||O},{default:l(()=>[m(_(a.name.charAt(0)),1)]),_:2},1032,["src"])]),d("div",Se,[d("h3",$e,_(a.name),1),d("p",Be,"ID: "+_(j(a.chat_id)),1)])]),a.description?(c(),g("p",je,_(a.description),1)):z("",!0),d("div",Je,[d("span",qe,[t(r,null,{default:l(()=>[t(L(Ce))]),_:1}),m(" "+_(a.current_members)+"/"+_(a.max_members),1)]),t(oe,{size:"small",type:a.is_public?"success":"warning"},{default:l(()=>[m(_(a.is_public?"公开":"私密"),1)]),_:2},1032,["type"])]),d("div",Le,[t(s,{type:"primary",size:"small",onClick:_e=>ee(a),disabled:P(a)},{default:l(()=>[m(_(P(a)?"已加入":"加入群聊"),1)]),_:2},1032,["onClick","disabled"]),t(s,{size:"small",onClick:_e=>te(a)},{default:l(()=>[...e[19]||(e[19]=[m(" 查看详情 ",-1)])]),_:1},8,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1}),w.value>N?(c(),g("div",Me,[t(ue,{"current-page":C.value,"onUpdate:currentPage":e[3]||(e[3]=a=>C.value=a),"page-size":N,total:w.value,layout:"prev, pager, next",onCurrentChange:X},null,8,["current-page","total"])])):z("",!0)]))])),[[pe,I.value]]),t(T,{modelValue:x.value,"onUpdate:modelValue":e[11]||(e[11]=a=>x.value=a),title:"创建群聊",width:"500px",onClose:G},{footer:l(()=>[t(s,{onClick:e[10]||(e[10]=a=>x.value=!1)},{default:l(()=>[...e[22]||(e[22]=[m("取消",-1)])]),_:1}),t(s,{type:"primary",onClick:Z,loading:S.value},{default:l(()=>[...e[23]||(e[23]=[m(" 创建 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(J,{model:n,rules:Q,ref_key:"createFormRef",ref:R,"label-width":"80px"},{default:l(()=>[t(f,{label:"群聊名称",prop:"name"},{default:l(()=>[t(u,{modelValue:n.name,"onUpdate:modelValue":e[4]||(e[4]=a=>n.name=a),placeholder:"请输入群聊名称",maxlength:"100"},null,8,["modelValue"])]),_:1}),t(f,{label:"群聊描述",prop:"description"},{default:l(()=>[t(u,{modelValue:n.description,"onUpdate:modelValue":e[5]||(e[5]=a=>n.description=a),type:"textarea",placeholder:"请输入群聊描述（可选）",maxlength:"500",rows:3},null,8,["modelValue"])]),_:1}),t(f,{label:"群聊头像",prop:"avatar_url"},{default:l(()=>[t(u,{modelValue:n.avatar_url,"onUpdate:modelValue":e[6]||(e[6]=a=>n.avatar_url=a),placeholder:"头像URL（可选）"},null,8,["modelValue"])]),_:1}),t(f,{label:"最大成员数",prop:"max_members"},{default:l(()=>[t(de,{modelValue:n.max_members,"onUpdate:modelValue":e[7]||(e[7]=a=>n.max_members=a),min:10,max:1e3,step:10},null,8,["modelValue"])]),_:1}),t(f,{label:"是否公开",prop:"is_public"},{default:l(()=>[t(ie,{modelValue:n.is_public,"onUpdate:modelValue":e[8]||(e[8]=a=>n.is_public=a)},null,8,["modelValue"]),e[20]||(e[20]=d("span",{class:"form-tip"},"公开群聊可被搜索到",-1))]),_:1}),$.value.length>0?(c(),M(f,{key:0,label:"关联群组",prop:"group_id"},{default:l(()=>[t(ce,{modelValue:n.group_id,"onUpdate:modelValue":e[9]||(e[9]=a=>n.group_id=a),placeholder:"选择关联的学习群组（可选）"},{default:l(()=>[(c(!0),g(H,null,K($.value,a=>(c(),M(me,{key:a.group_id,label:a.name,value:a.group_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[21]||(e[21]=d("div",{class:"form-tip"},"关联后可同步群组成员",-1))]),_:1})):z("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(T,{modelValue:U.value,"onUpdate:modelValue":e[14]||(e[14]=a=>U.value=a),title:"加入群聊",width:"400px"},{footer:l(()=>[t(s,{onClick:e[13]||(e[13]=a=>U.value=!1)},{default:l(()=>[...e[24]||(e[24]=[m("取消",-1)])]),_:1}),t(s,{type:"primary",onClick:ae,loading:B.value},{default:l(()=>[...e[25]||(e[25]=[m(" 发送申请 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[y.value?(c(),g("div",Ne,[d("div",Ge,[t(E,{size:40,src:y.value.avatar_url||O},{default:l(()=>[m(_(y.value.name.charAt(0)),1)]),_:1},8,["src"]),d("div",Pe,[d("h3",null,_(y.value.name),1),d("p",null,"ID: "+_(j(y.value.chat_id)),1)])]),t(J,{model:D,"label-width":"80px"},{default:l(()=>[t(f,{label:"申请理由",prop:"message"},{default:l(()=>[t(u,{modelValue:D.message,"onUpdate:modelValue":e[12]||(e[12]=a=>D.message=a),type:"textarea",placeholder:"请输入申请加入的理由（可选）",maxlength:"500",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])):z("",!0)]),_:1},8,["modelValue"])])}}},Ke=ve(Ee,[["__scopeId","data-v-01ee0046"]]);export{Ke as default};
