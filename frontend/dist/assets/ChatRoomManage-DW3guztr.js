import{_ as fe,u as ge,j as he,o as m,c as g,a as r,b as a,w as o,p as x,q as y,f as k,r as p,k as W,g as ye,v as we,h as c,x as I,F as G,n as X,d as M,t as v,e as R,l as be,y as ke,E as Re,i as qe}from"./index-CrPuRJEc.js";const Ce={class:"chat-room-manage"},ze={class:"manage-header"},xe={class:"header-actions"},Me={class:"chat-rooms-list"},$e={key:0,class:"empty-state"},Ve={key:1},Se={class:"room-header"},Je={class:"room-avatar"},De={class:"room-info"},Ne={class:"room-name"},Ae={class:"room-id"},je={class:"room-stats"},Be={class:"stat-item"},Te={class:"stat-value"},Ue={class:"stat-item"},Ee={class:"room-actions"},Le={class:"chat-rooms-list"},Oe={key:0,class:"empty-state"},Fe={key:1},Ie={class:"room-header"},Ge={class:"room-avatar"},He={class:"room-info"},Ke={class:"room-name"},Pe={class:"room-id"},Qe={class:"room-stats"},We={class:"stat-item"},Xe={class:"stat-value"},Ye={class:"stat-item"},Ze={class:"room-actions"},es={class:"requests-list"},ss={class:"requests-header"},ts={key:0,class:"empty-state"},as={key:1},os={class:"user-info"},ls={key:0,class:"review-info"},ns={class:"user-info"},rs={class:"user-details"},is={key:0,class:"request-message"},ds={key:1,class:"request-status"},Y="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",us={__name:"ChatRoomManage",setup(cs){const H=ye(),S=ge(),K=W(()=>{var t;return(t=S.user)==null?void 0:t.user_id}),J=k("created"),D=k(!1),j=k(!1),$=k([]),C=k([]),B=k([]),b=k(!1),u=k(null),V=qe({review_message:""}),Z=t=>({owner:"群主",admin:"管理员",member:"成员"})[t]||t,ee=t=>({owner:"danger",admin:"warning",member:"info"})[t]||"info",T=t=>{if(!t||t.length<=4)return t;let e="";for(let _=0;_<t.length;_++)_>0&&_%3===0&&(e+="-"),e+=t[_];return e},se=t=>new Date(t).toLocaleString("zh-CN"),te=W(()=>C.value.some(t=>t.role==="owner"||t.role==="admin")),U=async()=>{var t,e,_,f,d,h;D.value=!0;try{const n=((t=(await x.chatRooms.searchChatRooms({page:1,page_size:100})).data.data)==null?void 0:t.chat_rooms)||[];$.value=n.filter(i=>i.creator_id===K.value),C.value=n.filter(i=>i.creator_id!==K.value);for(const i of $.value)try{const w=await x.chatRooms.getJoinRequests(i.chat_room_id,{status_filter:"pending"});i.pending_requests=w.data.length||0}catch{i.pending_requests=0}for(const i of C.value)if(i.role==="admin")try{const w=await x.chatRooms.getJoinRequests(i.chat_room_id,{status_filter:"pending"});i.pending_requests=w.data.length||0}catch{i.pending_requests=0}else i.pending_requests=0}catch(l){let n="加载群聊失败";if((_=(e=l.response)==null?void 0:e.data)!=null&&_.detail)n+="："+l.response.data.detail;else if((d=(f=l.response)==null?void 0:f.data)!=null&&d.message)n+="："+l.response.data.message;else if(l.message)n+="："+l.message;else if((h=l.response)!=null&&h.data)try{n+="："+JSON.stringify(l.response.data)}catch{n+="：未知错误"}y.error(n)}finally{D.value=!1}},E=async()=>{var t,e,_,f,d,h;j.value=!0;try{const l=[],n=[...$.value,...C.value.filter(i=>i.role==="admin")];for(const i of n)try{const N=(((t=(await x.chatRooms.getJoinRequests(i.chat_room_id)).data.data)==null?void 0:t.join_requests)||[]).map(A=>({...A,avatar_url:null}));l.push(...N)}catch(w){console.error(`获取群聊 ${i.chat_room_id} 的请求失败:`,w)}B.value=l}catch(l){let n="加载请求失败";if((_=(e=l.response)==null?void 0:e.data)!=null&&_.detail)n+="："+l.response.data.detail;else if((d=(f=l.response)==null?void 0:f.data)!=null&&d.message)n+="："+l.response.data.message;else if(l.message)n+="："+l.message;else if((h=l.response)!=null&&h.data)try{n+="："+JSON.stringify(l.response.data)}catch{n+="：未知错误"}y.error(n)}finally{j.value=!1}},L=()=>{H.push("/chat-rooms/search")},P=t=>{H.push(`/chat-rooms/${t.chat_room_id}`)},ae=async t=>{var e,_,f,d,h,l;if(!t.pending_requests||t.pending_requests<=0){y.info("暂无待审批的请求");return}J.value="requests";try{const i=((e=(await x.chatRooms.getJoinRequests(t.chat_room_id,{status_filter:"pending"})).data.data)==null?void 0:e.join_requests)||[];i.length>0?(u.value=i[0],b.value=!0):(t.pending_requests=0,y.info("暂无待审批的请求"))}catch(n){let i="加载待审批请求失败";if((f=(_=n.response)==null?void 0:_.data)!=null&&f.detail)i+="："+n.response.data.detail;else if((h=(d=n.response)==null?void 0:d.data)!=null&&h.message)i+="："+n.response.data.message;else if(n.message)i+="："+n.message;else if((l=n.response)!=null&&l.data)try{i+="："+JSON.stringify(n.response.data)}catch{i+="：未知错误"}y.error(i)}},oe=t=>{y.info("编辑功能开发中...")},le=t=>{y.info("成员管理功能开发中...")},ne=async t=>{var e,_;try{await Re.confirm(`确定要退出群聊 "${t.name}" 吗？`,"确认退出",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),y.success("已退出群聊"),U()}catch(f){f!=="cancel"&&y.error("操作失败："+(((_=(e=f.response)==null?void 0:e.data)==null?void 0:_.detail)||f.message))}},re=t=>{u.value=t,b.value=!0},ie=t=>{u.value=t,b.value=!0},Q=async t=>{var e,_,f,d,h;try{if(!u.value)return;if(u.value.status&&u.value.status!=="pending"){y.info("该申请已处理，无需重复操作"),b.value=!1;return}const l={approve:t,review_message:V.review_message};await x.chatRooms.reviewJoinRequest(u.value.chat_room_id,u.value.request_id,l),y.success(t?"已批准加入申请":"已拒绝加入申请"),b.value=!1,V.review_message="",u.value=null,await E(),await U()}catch(l){let n="审批失败";if((_=(e=l.response)==null?void 0:e.data)!=null&&_.detail)n+="："+l.response.data.detail;else if((d=(f=l.response)==null?void 0:f.data)!=null&&d.message)n+="："+l.response.data.message;else if(l.message)n+="："+l.message;else if((h=l.response)!=null&&h.data)try{n+="："+JSON.stringify(l.response.data)}catch{n+="：未知错误"}y.error(n)}};return he(async()=>{if(S.isAuthenticated&&!S.user)try{await S.fetchUserInfo()}catch(t){console.error("获取用户信息失败:",t)}U(),J.value==="requests"&&E()}),(t,e)=>{const _=p("Search"),f=p("el-icon"),d=p("el-button"),h=p("el-empty"),l=p("el-avatar"),n=p("el-tag"),i=p("el-badge"),w=p("el-card"),N=p("el-col"),A=p("el-row"),O=p("el-tab-pane"),z=p("el-table-column"),de=p("el-table"),ue=p("el-tabs"),ce=p("el-alert"),_e=p("el-input"),me=p("el-form-item"),pe=p("el-form"),ve=p("el-dialog"),F=we("loading");return m(),g("div",Ce,[r("div",ze,[e[7]||(e[7]=r("h2",null,"群聊管理",-1)),r("div",xe,[a(d,{onClick:L},{default:o(()=>[a(f,null,{default:o(()=>[a(_)]),_:1}),e[6]||(e[6]=c(" 搜索群聊 ",-1))]),_:1})])]),a(ue,{modelValue:J.value,"onUpdate:modelValue":e[0]||(e[0]=s=>J.value=s),class:"manage-tabs"},{default:o(()=>[a(O,{label:"我创建的群聊",name:"created"},{default:o(()=>[I((m(),g("div",Me,[$.value.length===0?(m(),g("div",$e,[a(h,{description:"暂无创建的群聊"},{default:o(()=>[a(d,{type:"primary",onClick:L},{default:o(()=>[...e[8]||(e[8]=[c("创建群聊",-1)])]),_:1})]),_:1})])):(m(),g("div",Ve,[a(A,{gutter:20},{default:o(()=>[(m(!0),g(G,null,X($.value,s=>(m(),M(N,{xs:24,sm:12,md:8,lg:6,key:s.chat_room_id},{default:o(()=>[a(w,{class:"chat-room-card",shadow:"hover"},{default:o(()=>[r("div",Se,[r("div",Je,[a(l,{size:50,src:s.avatar_url||Y},{default:o(()=>[c(v(s.name.charAt(0)),1)]),_:2},1032,["src"])]),r("div",De,[r("h3",Ne,v(s.name),1),r("p",Ae,"ID: "+v(T(s.chat_id)),1)])]),r("div",je,[r("div",Be,[r("span",Te,v(s.current_members),1),e[9]||(e[9]=r("span",{class:"stat-label"},"成员数",-1))]),r("div",Ue,[a(n,{size:"small",type:s.is_public?"success":"warning"},{default:o(()=>[c(v(s.is_public?"公开":"私密"),1)]),_:2},1032,["type"])])]),r("div",Ee,[a(d,{type:"primary",size:"small",onClick:q=>P(s)},{default:o(()=>[...e[10]||(e[10]=[c(" 进入群聊 ",-1)])]),_:1},8,["onClick"]),a(d,{size:"small",onClick:q=>ae(s)},{default:o(()=>[e[11]||(e[11]=c(" 审批申请 ",-1)),s.pending_requests>0?(m(),M(i,{key:0,value:s.pending_requests,class:"item-badge"},null,8,["value"])):R("",!0)]),_:2},1032,["onClick"]),a(d,{size:"small",onClick:q=>oe(s)},{default:o(()=>[...e[12]||(e[12]=[c(" 编辑 ",-1)])]),_:1},8,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1})]))])),[[F,D.value]])]),_:1}),a(O,{label:"我加入的群聊",name:"joined"},{default:o(()=>[I((m(),g("div",Le,[C.value.length===0?(m(),g("div",Oe,[a(h,{description:"暂无加入的群聊"},{default:o(()=>[a(d,{type:"primary",onClick:L},{default:o(()=>[...e[13]||(e[13]=[c("搜索群聊",-1)])]),_:1})]),_:1})])):(m(),g("div",Fe,[a(A,{gutter:20},{default:o(()=>[(m(!0),g(G,null,X(C.value,s=>(m(),M(N,{xs:24,sm:12,md:8,lg:6,key:s.chat_room_id},{default:o(()=>[a(w,{class:"chat-room-card",shadow:"hover"},{default:o(()=>[r("div",Ie,[r("div",Ge,[a(l,{size:50,src:s.avatar_url||Y},{default:o(()=>[c(v(s.name.charAt(0)),1)]),_:2},1032,["src"])]),r("div",He,[r("h3",Ke,v(s.name),1),r("p",Pe,"ID: "+v(T(s.chat_id)),1),a(n,{size:"small",type:ee(s.role)},{default:o(()=>[c(v(Z(s.role)),1)]),_:2},1032,["type"])])]),r("div",Qe,[r("div",We,[r("span",Xe,v(s.current_members),1),e[14]||(e[14]=r("span",{class:"stat-label"},"成员数",-1))]),r("div",Ye,[a(n,{size:"small",type:s.is_public?"success":"warning"},{default:o(()=>[c(v(s.is_public?"公开":"私密"),1)]),_:2},1032,["type"])])]),r("div",Ze,[a(d,{type:"primary",size:"small",onClick:q=>P(s)},{default:o(()=>[...e[15]||(e[15]=[c(" 进入群聊 ",-1)])]),_:1},8,["onClick"]),s.role!=="member"?(m(),M(d,{key:0,size:"small",onClick:q=>le(s)},{default:o(()=>[...e[16]||(e[16]=[c(" 成员管理 ",-1)])]),_:1},8,["onClick"])):R("",!0),a(d,{size:"small",onClick:q=>ne(s),type:"danger",plain:""},{default:o(()=>[...e[17]||(e[17]=[c(" 退出群聊 ",-1)])]),_:1},8,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1})]))])),[[F,D.value]])]),_:1}),te.value?(m(),M(O,{key:0,label:"审批管理",name:"requests"},{default:o(()=>[I((m(),g("div",es,[r("div",ss,[e[19]||(e[19]=r("h3",null,"待审批的加入请求",-1)),a(d,{onClick:E,icon:be(ke)},{default:o(()=>[...e[18]||(e[18]=[c("刷新",-1)])]),_:1},8,["icon"])]),B.value.length===0?(m(),g("div",ts,[a(h,{description:"暂无待审批的请求"})])):(m(),g("div",as,[a(de,{data:B.value,style:{width:"100%"}},{default:o(()=>[a(z,{prop:"username",label:"申请人",width:"120"},{default:o(s=>[r("div",os,[a(l,{size:32,src:s.row.avatar_url},{default:o(()=>[c(v(s.row.username.charAt(0)),1)]),_:2},1032,["src"]),r("span",null,v(s.row.username),1)])]),_:1}),a(z,{prop:"chat_room_name",label:"群聊名称",width:"150"}),a(z,{prop:"chat_id",label:"群聊ID",width:"120"},{default:o(s=>[c(v(T(s.row.chat_id)),1)]),_:1}),a(z,{prop:"message",label:"申请理由","show-overflow-tooltip":""}),a(z,{prop:"created_at",label:"申请时间",width:"160"},{default:o(s=>[c(v(se(s.row.created_at)),1)]),_:1}),a(z,{label:"操作",width:"200",fixed:"right"},{default:o(s=>[a(d,{size:"small",type:"success",onClick:q=>re(s.row)},{default:o(()=>[...e[20]||(e[20]=[c(" 批准 ",-1)])]),_:1},8,["onClick"]),a(d,{size:"small",type:"danger",onClick:q=>ie(s.row)},{default:o(()=>[...e[21]||(e[21]=[c(" 拒绝 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]))])),[[F,j.value]])]),_:1})):R("",!0)]),_:1},8,["modelValue"]),a(ve,{modelValue:b.value,"onUpdate:modelValue":e[5]||(e[5]=s=>b.value=s),title:"审批加入申请",width:"400px"},{footer:o(()=>[a(d,{onClick:e[2]||(e[2]=s=>b.value=!1)},{default:o(()=>[...e[23]||(e[23]=[c("取消",-1)])]),_:1}),u.value&&(!u.value.status||u.value.status==="pending")?(m(),g(G,{key:0},[a(d,{type:"danger",onClick:e[3]||(e[3]=s=>Q(!1))},{default:o(()=>[...e[24]||(e[24]=[c("拒绝",-1)])]),_:1}),a(d,{type:"success",onClick:e[4]||(e[4]=s=>Q(!0))},{default:o(()=>[...e[25]||(e[25]=[c("批准",-1)])]),_:1})],64)):R("",!0)]),default:o(()=>[u.value?(m(),g("div",ls,[r("div",ns,[a(l,{size:40,src:u.value.avatar_url},{default:o(()=>[c(v(u.value.username.charAt(0)),1)]),_:1},8,["src"]),r("div",rs,[r("h4",null,v(u.value.username),1),r("p",null,"申请加入 "+v(u.value.chat_room_name),1)])]),u.value.message?(m(),g("div",is,[e[22]||(e[22]=r("label",null,"申请理由：",-1)),r("p",null,v(u.value.message),1)])):R("",!0),u.value.status&&u.value.status!=="pending"?(m(),g("div",ds,[a(ce,{title:u.value.status==="approved"?"该申请已批准":"该申请已拒绝",type:"info","show-icon":""},null,8,["title"])])):R("",!0),!u.value.status||u.value.status==="pending"?(m(),M(pe,{key:2,model:V,"label-width":"80px"},{default:o(()=>[a(me,{label:"审批意见"},{default:o(()=>[a(_e,{modelValue:V.review_message,"onUpdate:modelValue":e[1]||(e[1]=s=>V.review_message=s),type:"textarea",placeholder:"请输入审批意见（可选）",maxlength:"500",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])):R("",!0)])):R("",!0)]),_:1},8,["modelValue"])])}}},ms=fe(us,[["__scopeId","data-v-ea0fd039"]]);export{ms as default};
