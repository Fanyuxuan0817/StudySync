import{_ as te,u as le,j as ae,o as c,c as y,a as m,b as t,w as a,m as B,r as s,f as i,g as ne,F as j,n as P,d as w,h as f,e as G,i as H,k as oe}from"./index-BpwqB7Vr.js";import{u as de}from"./user-D9ZoCelv.js";const se={class:"checkin-container"},ie={class:"checkin-form-card"},re={class:"recent-checkins"},ue={key:0},ce={key:1},pe={class:"dialog-footer"},me={class:"dialog-footer"},_e={__name:"Checkin",setup(fe){ne();const C=le(),x=de(),D=i(null),U=i(null),F=i(!1),S=i(!1),R=i(!1),p=i(""),h=i(""),I=i([]),v=i(!1),g=i(!1),b=i(null),d=H({plan_id:"",hours:2,content:"",checkin_date:new Date}),o=H({plan_id:"",hours:2,content:"",checkin_date:new Date}),N={plan_id:[{required:!0,message:"请选择学习计划",trigger:"change"}],hours:[{required:!0,message:"请输入学习时长",trigger:["blur","change"]},{type:"number",min:.5,message:"学习时长至少 0.5 小时",trigger:["blur","change"]}],content:[{required:!0,message:"请输入学习内容",trigger:"blur"},{min:5,message:"学习内容至少 5 个字符",trigger:"blur"}],checkin_date:[{required:!0,message:"请选择打卡日期",trigger:"change"}]},O=oe(()=>x.plans),J=async()=>{var n,e;if(D.value)try{await D.value.validate(),F.value=!0,p.value="",h.value="";const k=new Date(d.checkin_date).toISOString().split("T")[0];await x.createCheckin({...d,checkin_date:k}),h.value="打卡成功！",setTimeout(()=>{d.hours=2,d.content="",d.checkin_date=new Date},1500)}catch(r){p.value=((e=(n=r.response)==null?void 0:n.data)==null?void 0:e.detail)||"打卡失败，请稍后重试"}finally{F.value=!1}},q=async()=>{try{const n=await B.checkins.getCheckins({page_size:10});I.value=n.data.data.items.map(e=>({checkin_id:e.checkin_id,date:e.date,hours:e.hours,content:e.content,plan_id:e.plan_id}))}catch(n){console.error("获取最近打卡记录失败:",n)}},K=n=>{b.value=n.checkin_id,o.plan_id=n.plan_id,o.hours=n.hours,o.content=n.content,o.checkin_date=new Date(n.date),v.value=!0},Q=async()=>{var n,e;if(U.value)try{await U.value.validate(),S.value=!0,p.value="";const k=new Date(o.checkin_date).toISOString().split("T")[0];await B.checkins.updateCheckin(b.value,{...o,checkin_date:k}),h.value="编辑成功！",v.value=!1,await q()}catch(r){p.value=((e=(n=r.response)==null?void 0:n.data)==null?void 0:e.detail)||"编辑失败，请稍后重试"}finally{S.value=!1}},W=n=>{b.value=n.checkin_id,g.value=!0},X=async()=>{var n,e;try{R.value=!0,p.value="",await B.checkins.deleteCheckin(b.value),h.value="删除成功！",g.value=!1,await q()}catch(r){p.value=((e=(n=r.response)==null?void 0:n.data)==null?void 0:e.detail)||"删除失败，请稍后重试"}finally{R.value=!1}};return ae(async()=>{C.isAuthenticated&&!C.user&&await C.fetchUserInfo(),await x.fetchPlans(),await q()}),(n,e)=>{const r=s("el-option"),k=s("el-select"),u=s("el-form-item"),T=s("el-input-number"),$=s("el-input"),z=s("el-date-picker"),_=s("el-button"),L=s("el-form"),M=s("el-alert"),A=s("el-card"),V=s("el-table-column"),Y=s("el-table"),Z=s("el-empty"),E=s("el-dialog");return c(),y("div",se,[e[22]||(e[22]=m("h1",{class:"page-title"},"学习打卡",-1)),m("div",ie,[t(A,{"body-style":{padding:"30px"}},{default:a(()=>[e[13]||(e[13]=m("h2",{class:"card-title"},"今日学习记录",-1)),t(L,{model:d,rules:N,ref_key:"checkinFormRef",ref:D,"label-width":"100px",class:"checkin-form"},{default:a(()=>[t(u,{label:"学习计划",prop:"plan_id"},{default:a(()=>[t(k,{modelValue:d.plan_id,"onUpdate:modelValue":e[0]||(e[0]=l=>d.plan_id=l),placeholder:"请选择学习计划",style:{width:"100%"}},{default:a(()=>[(c(!0),y(j,null,P(O.value,l=>(c(),w(r,{key:l.plan_id,label:l.title,value:l.plan_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"学习时长（小时）",prop:"hours"},{default:a(()=>[t(T,{modelValue:d.hours,"onUpdate:modelValue":e[1]||(e[1]=l=>d.hours=l),modelModifiers:{number:!0},min:.5,max:12,step:.5,placeholder:"请输入学习时长",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(u,{label:"学习内容",prop:"content"},{default:a(()=>[t($,{modelValue:d.content,"onUpdate:modelValue":e[2]||(e[2]=l=>d.content=l),type:"textarea",placeholder:"请输入学习内容",rows:4},null,8,["modelValue"])]),_:1}),t(u,{label:"打卡日期",prop:"checkin_date"},{default:a(()=>[t(z,{modelValue:d.checkin_date,"onUpdate:modelValue":e[3]||(e[3]=l=>d.checkin_date=l),type:"date",placeholder:"选择打卡日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(u,null,{default:a(()=>[t(_,{type:"primary",class:"submit-btn",onClick:J,loading:F.value},{default:a(()=>[...e[12]||(e[12]=[f(" 提交打卡 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),p.value?(c(),w(M,{key:0,type:"error",title:p.value,"show-icon":"",class:"error-alert"},null,8,["title"])):G("",!0),h.value?(c(),w(M,{key:1,type:"success",title:h.value,"show-icon":"",class:"success-alert"},null,8,["title"])):G("",!0)]),_:1})]),m("div",re,[e[16]||(e[16]=m("h2",{class:"card-title"},"最近打卡记录",-1)),t(A,{"body-style":{padding:"20px"}},{default:a(()=>[I.value.length>0?(c(),y("div",ue,[t(Y,{data:I.value,style:{width:"100%"}},{default:a(()=>[t(V,{prop:"date",label:"打卡日期",width:"150"}),t(V,{prop:"hours",label:"学习时长（小时）",width:"150"}),t(V,{prop:"content",label:"学习内容"}),t(V,{label:"操作",width:"180",fixed:"right"},{default:a(l=>[t(_,{type:"primary",size:"small",onClick:ee=>K(l.row),style:{"margin-right":"8px"}},{default:a(()=>[...e[14]||(e[14]=[f(" 编辑 ",-1)])]),_:1},8,["onClick"]),t(_,{type:"danger",size:"small",onClick:ee=>W(l.row)},{default:a(()=>[...e[15]||(e[15]=[f(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])):(c(),y("div",ce,[t(Z,{description:"暂无打卡记录"})]))]),_:1})]),t(E,{modelValue:v.value,"onUpdate:modelValue":e[9]||(e[9]=l=>v.value=l),title:"编辑打卡记录",width:"500px"},{footer:a(()=>[m("span",pe,[t(_,{onClick:e[8]||(e[8]=l=>v.value=!1)},{default:a(()=>[...e[17]||(e[17]=[f("取消",-1)])]),_:1}),t(_,{type:"primary",onClick:Q,loading:S.value},{default:a(()=>[...e[18]||(e[18]=[f("保存修改",-1)])]),_:1},8,["loading"])])]),default:a(()=>[t(L,{model:o,rules:N,ref_key:"editFormRef",ref:U,"label-width":"100px"},{default:a(()=>[t(u,{label:"学习计划",prop:"plan_id"},{default:a(()=>[t(k,{modelValue:o.plan_id,"onUpdate:modelValue":e[4]||(e[4]=l=>o.plan_id=l),placeholder:"请选择学习计划",style:{width:"100%"}},{default:a(()=>[(c(!0),y(j,null,P(O.value,l=>(c(),w(r,{key:l.plan_id,label:l.title,value:l.plan_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(u,{label:"学习时长（小时）",prop:"hours"},{default:a(()=>[t(T,{modelValue:o.hours,"onUpdate:modelValue":e[5]||(e[5]=l=>o.hours=l),modelModifiers:{number:!0},min:.5,max:12,step:.5,placeholder:"请输入学习时长",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(u,{label:"学习内容",prop:"content"},{default:a(()=>[t($,{modelValue:o.content,"onUpdate:modelValue":e[6]||(e[6]=l=>o.content=l),type:"textarea",placeholder:"请输入学习内容",rows:4},null,8,["modelValue"])]),_:1}),t(u,{label:"打卡日期",prop:"checkin_date"},{default:a(()=>[t(z,{modelValue:o.checkin_date,"onUpdate:modelValue":e[7]||(e[7]=l=>o.checkin_date=l),type:"date",placeholder:"选择打卡日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(E,{modelValue:g.value,"onUpdate:modelValue":e[11]||(e[11]=l=>g.value=l),title:"确认删除",width:"300px"},{footer:a(()=>[m("span",me,[t(_,{onClick:e[10]||(e[10]=l=>g.value=!1)},{default:a(()=>[...e[19]||(e[19]=[f("取消",-1)])]),_:1}),t(_,{type:"danger",onClick:X,loading:R.value},{default:a(()=>[...e[20]||(e[20]=[f("确认删除",-1)])]),_:1},8,["loading"])])]),default:a(()=>[e[21]||(e[21]=m("p",null,"您确定要删除这条打卡记录吗？",-1))]),_:1},8,["modelValue"])])}}},ve=te(_e,[["__scopeId","data-v-9f375fea"]]);export{ve as default};
