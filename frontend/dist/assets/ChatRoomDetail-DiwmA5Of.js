import{_ as fe,u as ge,j as be,o as p,c as f,b as t,a as n,w as a,t as r,h as i,d as B,p as S,q as h,f as g,r as m,G as ye,g as he,k as T,e as k,F as E,n as G,i as we}from"./index-CrPuRJEc.js";const ke={class:"chat-room-detail"},Re={key:0,class:"loading-overlay"},Me={key:1},Ce={class:"detail-header"},Ve={class:"room-info"},xe={class:"room-avatar"},je={class:"room-details"},Se={class:"room-name"},qe={class:"room-id"},Le={class:"room-stats"},Ue={class:"member-count"},ze={class:"header-actions"},Ae={class:"info-section"},De={key:0,class:"info-section"},Je={class:"group-info"},Ne={class:"members-section"},Be={class:"members-header"},Te={class:"members-list"},$e={class:"member-avatar"},Fe={class:"member-info"},Ie={class:"member-name"},Ee={class:"member-role"},Ge={class:"member-stats"},Oe={class:"join-time"},He={key:0,class:"last-active"},Ke={class:"requests-section"},Pe={class:"requests-header"},Qe={class:"requests-list"},We={class:"request-user"},Xe={class:"username"},Ye={class:"request-content"},Ze={key:0,class:"request-message"},es={class:"request-time"},ss={class:"request-status"},ts={key:0,class:"review-time"},as={key:1,class:"review-message"},os={class:"join-dialog-content"},ls="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",ns={__name:"ChatRoomDetail",setup(rs){const R=ye(),A=he(),O=ge(),H=T(()=>{var s;return(s=O.user)==null?void 0:s.user_id}),D=g(!1),J=g(!1),d=g({}),q=g([]),M=g([]),C=g(!1),V=g(!1),$=g("info"),L=g(""),U=g("all"),x=g(!1),w=we({message:""}),K=T(()=>L.value?q.value.filter(s=>s.username.toLowerCase().includes(L.value.toLowerCase())):q.value),P=T(()=>U.value==="all"?M.value:M.value.filter(s=>s.status===U.value)),Q=s=>{if(!s||s.length<=4)return s;let e="";for(let c=0;c<s.length;c++)c>0&&c%3===0&&(e+="-"),e+=s[c];return e},j=s=>new Date(s).toLocaleString("zh-CN"),W=s=>({owner:"群主",admin:"管理员",member:"成员"})[s]||s,X=s=>({owner:"danger",admin:"warning",member:"info"})[s]||"info",Y=s=>({pending:"待审批",approved:"已批准",rejected:"已拒绝",cancelled:"已取消"})[s]||s,Z=s=>({pending:"warning",approved:"success",rejected:"danger",cancelled:"info"})[s]||"info",ee=()=>{A.back()},se=s=>{A.push(`/groups/${s}`)},te=()=>{h.info("聊天功能开发中...")},ae=async()=>{var s,e,c,b,v,u;D.value=!0;try{const l=await S.chatRooms.getChatRoom(R.params.id);d.value=l.data.data}catch(l){let _="加载群聊信息失败";((s=l.response)==null?void 0:s.status)===404?_="抱歉，该群聊不存在或已关闭":((e=l.response)==null?void 0:e.status)===403?_="抱歉，该群聊不对外开放":(b=(c=l.response)==null?void 0:c.data)!=null&&b.detail?_+="："+l.response.data.detail:(u=(v=l.response)==null?void 0:v.data)!=null&&u.message?_+="："+l.response.data.message:l.message&&(_+="："+l.message),h.error(_),A.push("/chat-rooms")}finally{D.value=!1}},oe=async()=>{var s,e,c,b,v;try{const u=await S.chatRooms.getChatRoomMembers(R.params.id);q.value=u.data.data.members}catch(u){let l="加载成员列表失败";if((e=(s=u.response)==null?void 0:s.data)!=null&&e.detail)l+="："+u.response.data.detail;else if((b=(c=u.response)==null?void 0:c.data)!=null&&b.message)l+="："+u.response.data.message;else if(u.message)l+="："+u.message;else if((v=u.response)!=null&&v.data)try{l+="："+JSON.stringify(u.response.data)}catch{l+="：未知错误"}h.error(l)}},le=async()=>{var s,e,c,b,v,u;try{const l=await S.chatRooms.getJoinRequests(R.params.id);(s=l.data.data)!=null&&s.join_requests?M.value=l.data.data.join_requests:l.data.data?M.value=l.data.data:l.data&&(M.value=l.data)}catch(l){let _="加载申请历史失败";if((c=(e=l.response)==null?void 0:e.data)!=null&&c.detail)_+="："+l.response.data.detail;else if((v=(b=l.response)==null?void 0:b.data)!=null&&v.message)_+="："+l.response.data.message;else if(l.message)_+="："+l.message;else if((u=l.response)!=null&&u.data)try{_+="："+JSON.stringify(l.response.data)}catch{_+="：未知错误"}h.error(_)}},ne=async()=>{try{const e=(await S.chatRooms.getChatRoomMembers(R.params.id)).data.data.members.find(c=>c.user_id===H.value);e?(C.value=!0,V.value=e.role==="owner"||e.role==="admin"):(C.value=!1,V.value=!1)}catch{C.value=!1,V.value=!1,console.log("用户不是群聊成员或群聊不存在")}},re=async()=>{var s,e;if(!w.message.trim()){h.warning("请输入申请理由");return}J.value=!0;try{await S.chatRooms.createJoinRequest(R.params.id,{message:w.message.trim()}),h.success("加入申请已提交，请等待审批"),x.value=!1,w.message=""}catch(c){h.error("提交申请失败："+(((e=(s=c.response)==null?void 0:s.data)==null?void 0:e.detail)||c.message))}finally{J.value=!1}};return be(async()=>{await ae(),await ne(),C.value&&(await oe(),V.value&&await le())}),(s,e)=>{const c=m("el-spinner"),b=m("ArrowLeft"),v=m("el-icon"),u=m("el-button"),l=m("el-avatar"),_=m("el-tag"),ie=m("User"),y=m("el-descriptions-item"),de=m("el-descriptions"),F=m("el-card"),N=m("el-tab-pane"),ue=m("Search"),I=m("el-input"),z=m("el-radio-button"),ce=m("el-radio-group"),me=m("el-tabs"),_e=m("el-form-item"),pe=m("el-form"),ve=m("el-dialog");return p(),f("div",ke,[D.value?(p(),f("div",Re,[t(c,{size:"60"}),e[8]||(e[8]=n("p",{class:"loading-text"},"加载中，请稍候...",-1))])):(p(),f("div",Me,[n("div",Ce,[t(u,{type:"text",onClick:ee,class:"back-button"},{default:a(()=>[t(v,null,{default:a(()=>[t(b)]),_:1}),e[9]||(e[9]=i(" 返回 ",-1))]),_:1}),n("div",Ve,[n("div",xe,[t(l,{size:60,src:d.value.avatar_url||ls},{default:a(()=>{var o;return[i(r((o=d.value.name)==null?void 0:o.charAt(0)),1)]}),_:1},8,["src"])]),n("div",je,[n("h1",Se,r(d.value.name),1),n("p",qe,"群聊ID: "+r(Q(d.value.chat_id)),1),n("div",Le,[t(_,{size:"small",type:d.value.is_public?"success":"warning"},{default:a(()=>[i(r(d.value.is_public?"公开群聊":"私密群聊"),1)]),_:1},8,["type"]),n("span",Ue,[t(v,null,{default:a(()=>[t(ie)]),_:1}),i(" "+r(d.value.current_members)+"/"+r(d.value.max_members)+" 成员 ",1)])])])]),n("div",ze,[C.value?(p(),B(u,{key:1,type:"success",onClick:te},{default:a(()=>[...e[11]||(e[11]=[i(" 进入群聊 ",-1)])]),_:1})):(p(),B(u,{key:0,type:"primary",onClick:e[0]||(e[0]=o=>x.value=!0),disabled:d.value.current_members>=d.value.max_members},{default:a(()=>[...e[10]||(e[10]=[i(" 申请加入 ",-1)])]),_:1},8,["disabled"]))])]),t(me,{modelValue:$.value,"onUpdate:modelValue":e[4]||(e[4]=o=>$.value=o),class:"detail-tabs"},{default:a(()=>[t(N,{label:"群聊信息",name:"info"},{default:a(()=>[t(F,null,{default:a(()=>[n("div",Ae,[e[12]||(e[12]=n("h3",null,"基本信息",-1)),t(de,{column:1,border:""},{default:a(()=>[t(y,{label:"群聊名称"},{default:a(()=>[i(r(d.value.name),1)]),_:1}),t(y,{label:"群聊ID"},{default:a(()=>[i(r(d.value.chat_id),1)]),_:1}),t(y,{label:"群聊描述"},{default:a(()=>[i(r(d.value.description||"暂无描述"),1)]),_:1}),t(y,{label:"创建者"},{default:a(()=>[i(r(d.value.creator_name||"未知"),1)]),_:1}),t(y,{label:"创建时间"},{default:a(()=>[i(r(j(d.value.created_at)),1)]),_:1}),t(y,{label:"最大成员数"},{default:a(()=>[i(r(d.value.max_members),1)]),_:1}),t(y,{label:"是否公开"},{default:a(()=>[t(_,{type:d.value.is_public?"success":"warning"},{default:a(()=>[i(r(d.value.is_public?"公开":"私密"),1)]),_:1},8,["type"])]),_:1})]),_:1})]),d.value.group_info?(p(),f("div",De,[e[14]||(e[14]=n("h3",null,"关联的学习群组",-1)),t(F,{shadow:"never"},{default:a(()=>[n("div",Je,[n("h4",null,r(d.value.group_info.name),1),n("p",null,r(d.value.group_info.description),1),t(u,{type:"text",onClick:e[1]||(e[1]=o=>se(d.value.group_info.group_id))},{default:a(()=>[...e[13]||(e[13]=[i(" 查看群组详情 ",-1)])]),_:1})])]),_:1})])):k("",!0)]),_:1})]),_:1}),t(N,{label:"成员列表",name:"members"},{default:a(()=>[n("div",Ne,[n("div",Be,[n("h3",null,"群聊成员 ("+r(q.value.length)+")",1),t(I,{modelValue:L.value,"onUpdate:modelValue":e[2]||(e[2]=o=>L.value=o),placeholder:"搜索成员",style:{width:"200px"},clearable:""},{prefix:a(()=>[t(v,null,{default:a(()=>[t(ue)]),_:1})]),_:1},8,["modelValue"])]),n("div",Te,[(p(!0),f(E,null,G(K.value,o=>(p(),f("div",{key:o.user_id,class:"member-item"},[n("div",$e,[t(l,{size:40,src:o.avatar_url},{default:a(()=>[i(r(o.username.charAt(0)),1)]),_:2},1032,["src"])]),n("div",Fe,[n("div",Ie,r(o.username),1),n("div",Ee,[t(_,{size:"small",type:X(o.role)},{default:a(()=>[i(r(W(o.role)),1)]),_:2},1032,["type"])])]),n("div",Ge,[n("div",Oe,"加入时间："+r(j(o.joined_at)),1),o.last_active_at?(p(),f("div",He," 最后活跃："+r(j(o.last_active_at)),1)):k("",!0)])]))),128))])])]),_:1}),V.value?(p(),B(N,{key:0,label:"加入申请",name:"requests"},{default:a(()=>[n("div",Ke,[n("div",Pe,[e[19]||(e[19]=n("h3",null,"加入申请历史",-1)),t(ce,{modelValue:U.value,"onUpdate:modelValue":e[3]||(e[3]=o=>U.value=o),size:"small"},{default:a(()=>[t(z,{label:"all"},{default:a(()=>[...e[15]||(e[15]=[i("全部",-1)])]),_:1}),t(z,{label:"pending"},{default:a(()=>[...e[16]||(e[16]=[i("待审批",-1)])]),_:1}),t(z,{label:"approved"},{default:a(()=>[...e[17]||(e[17]=[i("已批准",-1)])]),_:1}),t(z,{label:"rejected"},{default:a(()=>[...e[18]||(e[18]=[i("已拒绝",-1)])]),_:1})]),_:1},8,["modelValue"])]),n("div",Qe,[(p(!0),f(E,null,G(P.value,o=>(p(),f("div",{key:o.request_id,class:"request-item"},[n("div",We,[t(l,{size:32,src:o.avatar_url},{default:a(()=>[i(r(o.username.charAt(0)),1)]),_:2},1032,["src"]),n("span",Xe,r(o.username),1)]),n("div",Ye,[o.message?(p(),f("div",Ze," 申请理由："+r(o.message),1)):k("",!0),n("div",es," 申请时间："+r(j(o.created_at)),1),n("div",ss,[t(_,{type:Z(o.status)},{default:a(()=>[i(r(Y(o.status)),1)]),_:2},1032,["type"]),o.reviewed_at?(p(),f("span",ts," 审批时间："+r(j(o.reviewed_at)),1)):k("",!0)]),o.review_message?(p(),f("div",as," 审批意见："+r(o.review_message),1)):k("",!0)])]))),128))])])]),_:1})):k("",!0)]),_:1},8,["modelValue"]),t(ve,{modelValue:x.value,"onUpdate:modelValue":e[7]||(e[7]=o=>x.value=o),title:"申请加入群聊",width:"400px"},{footer:a(()=>[t(u,{onClick:e[6]||(e[6]=o=>x.value=!1)},{default:a(()=>[...e[20]||(e[20]=[i("取消",-1)])]),_:1}),t(u,{type:"primary",onClick:re,loading:J.value},{default:a(()=>[...e[21]||(e[21]=[i(" 提交申请 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[n("div",os,[t(pe,{model:w,"label-width":"80px"},{default:a(()=>[t(_e,{label:"申请理由"},{default:a(()=>[t(I,{modelValue:w.message,"onUpdate:modelValue":e[5]||(e[5]=o=>w.message=o),type:"textarea",placeholder:"请输入申请加入的理由（可选）",maxlength:"500",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"])]))])}}},ds=fe(ns,[["__scopeId","data-v-d4495e6d"]]);export{ds as default};
