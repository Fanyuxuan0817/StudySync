import{_ as ve,u as fe,j as ge,o as v,c as b,a as n,b as t,w as a,t as r,h as i,d as N,m as S,l as h,f as g,r as m,C as be,g as ye,k as B,e as k,F as E,n as O,i as he}from"./index-DnlmHtx4.js";const we={class:"chat-room-detail"},ke={class:"detail-header"},Re={class:"room-info"},Ce={class:"room-avatar"},Me={class:"room-details"},Ve={class:"room-name"},xe={class:"room-id"},je={class:"room-stats"},Se={class:"member-count"},qe={class:"header-actions"},Le={class:"info-section"},Ue={key:0,class:"info-section"},Ae={class:"group-info"},De={class:"members-section"},ze={class:"members-header"},Je={class:"members-list"},Ne={class:"member-avatar"},Be={class:"member-info"},Te={class:"member-name"},$e={class:"member-role"},Fe={class:"member-stats"},Ie={class:"join-time"},Ee={key:0,class:"last-active"},Oe={class:"requests-section"},Ge={class:"requests-header"},He={class:"requests-list"},Ke={class:"request-user"},Pe={class:"username"},Qe={class:"request-content"},We={key:0,class:"request-message"},Xe={class:"request-time"},Ye={class:"request-status"},Ze={key:0,class:"review-time"},es={key:1,class:"review-message"},ss={class:"join-dialog-content"},ts="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",as={__name:"ChatRoomDetail",setup(os){const R=be(),D=ye(),G=fe(),H=B(()=>{var s;return(s=G.user)==null?void 0:s.user_id}),T=g(!1),z=g(!1),d=g({}),q=g([]),C=g([]),M=g(!1),V=g(!1),$=g("info"),L=g(""),U=g("all"),x=g(!1),w=he({message:""}),K=B(()=>L.value?q.value.filter(s=>s.username.toLowerCase().includes(L.value.toLowerCase())):q.value),P=B(()=>U.value==="all"?C.value:C.value.filter(s=>s.status===U.value)),Q=s=>{if(!s||s.length<=4)return s;let e="";for(let u=0;u<s.length;u++)u>0&&u%3===0&&(e+="-"),e+=s[u];return e},j=s=>new Date(s).toLocaleString("zh-CN"),W=s=>({owner:"群主",admin:"管理员",member:"成员"})[s]||s,X=s=>({owner:"danger",admin:"warning",member:"info"})[s]||"info",Y=s=>({pending:"待审批",approved:"已批准",rejected:"已拒绝",cancelled:"已取消"})[s]||s,Z=s=>({pending:"warning",approved:"success",rejected:"danger",cancelled:"info"})[s]||"info",ee=()=>{D.back()},se=s=>{D.push(`/groups/${s}`)},te=()=>{h.info("聊天功能开发中...")},ae=async()=>{var s,e,u,f,_,c;T.value=!0;try{const l=await S.chatRooms.getChatRoom(R.params.id);d.value=l.data.data}catch(l){let p="加载群聊信息失败";((s=l.response)==null?void 0:s.status)===404?p="抱歉，该群聊不存在或已关闭":((e=l.response)==null?void 0:e.status)===403?p="抱歉，该群聊不对外开放":(f=(u=l.response)==null?void 0:u.data)!=null&&f.detail?p+="："+l.response.data.detail:(c=(_=l.response)==null?void 0:_.data)!=null&&c.message?p+="："+l.response.data.message:l.message&&(p+="："+l.message),h.error(p),D.push("/chat-rooms")}finally{T.value=!1}},oe=async()=>{var s,e,u,f,_;try{const c=await S.chatRooms.getChatRoomMembers(R.params.id);q.value=c.data.data.members}catch(c){let l="加载成员列表失败";if((e=(s=c.response)==null?void 0:s.data)!=null&&e.detail)l+="："+c.response.data.detail;else if((f=(u=c.response)==null?void 0:u.data)!=null&&f.message)l+="："+c.response.data.message;else if(c.message)l+="："+c.message;else if((_=c.response)!=null&&_.data)try{l+="："+JSON.stringify(c.response.data)}catch{l+="：未知错误"}h.error(l)}},le=async()=>{var s,e,u,f,_,c;try{const l=await S.chatRooms.getJoinRequests(R.params.id);(s=l.data.data)!=null&&s.join_requests?C.value=l.data.data.join_requests:l.data.data?C.value=l.data.data:l.data&&(C.value=l.data)}catch(l){let p="加载申请历史失败";if((u=(e=l.response)==null?void 0:e.data)!=null&&u.detail)p+="："+l.response.data.detail;else if((_=(f=l.response)==null?void 0:f.data)!=null&&_.message)p+="："+l.response.data.message;else if(l.message)p+="："+l.message;else if((c=l.response)!=null&&c.data)try{p+="："+JSON.stringify(l.response.data)}catch{p+="：未知错误"}h.error(p)}},ne=async()=>{try{const e=(await S.chatRooms.getChatRoomMembers(R.params.id)).data.data.members.find(u=>u.user_id===H.value);e?(M.value=!0,V.value=e.role==="owner"||e.role==="admin"):(M.value=!1,V.value=!1)}catch{M.value=!1,V.value=!1,console.log("用户不是群聊成员或群聊不存在")}},re=async()=>{var s,e;if(!w.message.trim()){h.warning("请输入申请理由");return}z.value=!0;try{await S.chatRooms.createJoinRequest(R.params.id,{message:w.message.trim()}),h.success("加入申请已提交，请等待审批"),x.value=!1,w.message=""}catch(u){h.error("提交申请失败："+(((e=(s=u.response)==null?void 0:s.data)==null?void 0:e.detail)||u.message))}finally{z.value=!1}};return ge(async()=>{await ae(),await ne(),M.value&&(await oe(),V.value&&await le())}),(s,e)=>{const u=m("ArrowLeft"),f=m("el-icon"),_=m("el-button"),c=m("el-avatar"),l=m("el-tag"),p=m("User"),y=m("el-descriptions-item"),ie=m("el-descriptions"),F=m("el-card"),J=m("el-tab-pane"),de=m("Search"),I=m("el-input"),A=m("el-radio-button"),ue=m("el-radio-group"),ce=m("el-tabs"),me=m("el-form-item"),_e=m("el-form"),pe=m("el-dialog");return v(),b("div",we,[n("div",ke,[t(_,{type:"text",onClick:ee,class:"back-button"},{default:a(()=>[t(f,null,{default:a(()=>[t(u)]),_:1}),e[8]||(e[8]=i(" 返回 ",-1))]),_:1}),n("div",Re,[n("div",Ce,[t(c,{size:60,src:d.value.avatar_url||ts},{default:a(()=>{var o;return[i(r((o=d.value.name)==null?void 0:o.charAt(0)),1)]}),_:1},8,["src"])]),n("div",Me,[n("h1",Ve,r(d.value.name),1),n("p",xe,"群聊ID: "+r(Q(d.value.chat_id)),1),n("div",je,[t(l,{size:"small",type:d.value.is_public?"success":"warning"},{default:a(()=>[i(r(d.value.is_public?"公开群聊":"私密群聊"),1)]),_:1},8,["type"]),n("span",Se,[t(f,null,{default:a(()=>[t(p)]),_:1}),i(" "+r(d.value.current_members)+"/"+r(d.value.max_members)+" 成员 ",1)])])])]),n("div",qe,[M.value?(v(),N(_,{key:1,type:"success",onClick:te},{default:a(()=>[...e[10]||(e[10]=[i(" 进入群聊 ",-1)])]),_:1})):(v(),N(_,{key:0,type:"primary",onClick:e[0]||(e[0]=o=>x.value=!0),disabled:d.value.current_members>=d.value.max_members},{default:a(()=>[...e[9]||(e[9]=[i(" 申请加入 ",-1)])]),_:1},8,["disabled"]))])]),t(ce,{modelValue:$.value,"onUpdate:modelValue":e[4]||(e[4]=o=>$.value=o),class:"detail-tabs"},{default:a(()=>[t(J,{label:"群聊信息",name:"info"},{default:a(()=>[t(F,null,{default:a(()=>[n("div",Le,[e[11]||(e[11]=n("h3",null,"基本信息",-1)),t(ie,{column:1,border:""},{default:a(()=>[t(y,{label:"群聊名称"},{default:a(()=>[i(r(d.value.name),1)]),_:1}),t(y,{label:"群聊ID"},{default:a(()=>[i(r(d.value.chat_id),1)]),_:1}),t(y,{label:"群聊描述"},{default:a(()=>[i(r(d.value.description||"暂无描述"),1)]),_:1}),t(y,{label:"创建者"},{default:a(()=>[i(r(d.value.creator_name||"未知"),1)]),_:1}),t(y,{label:"创建时间"},{default:a(()=>[i(r(j(d.value.created_at)),1)]),_:1}),t(y,{label:"最大成员数"},{default:a(()=>[i(r(d.value.max_members),1)]),_:1}),t(y,{label:"是否公开"},{default:a(()=>[t(l,{type:d.value.is_public?"success":"warning"},{default:a(()=>[i(r(d.value.is_public?"公开":"私密"),1)]),_:1},8,["type"])]),_:1})]),_:1})]),d.value.group_info?(v(),b("div",Ue,[e[13]||(e[13]=n("h3",null,"关联的学习群组",-1)),t(F,{shadow:"never"},{default:a(()=>[n("div",Ae,[n("h4",null,r(d.value.group_info.name),1),n("p",null,r(d.value.group_info.description),1),t(_,{type:"text",onClick:e[1]||(e[1]=o=>se(d.value.group_info.group_id))},{default:a(()=>[...e[12]||(e[12]=[i(" 查看群组详情 ",-1)])]),_:1})])]),_:1})])):k("",!0)]),_:1})]),_:1}),t(J,{label:"成员列表",name:"members"},{default:a(()=>[n("div",De,[n("div",ze,[n("h3",null,"群聊成员 ("+r(q.value.length)+")",1),t(I,{modelValue:L.value,"onUpdate:modelValue":e[2]||(e[2]=o=>L.value=o),placeholder:"搜索成员",style:{width:"200px"},clearable:""},{prefix:a(()=>[t(f,null,{default:a(()=>[t(de)]),_:1})]),_:1},8,["modelValue"])]),n("div",Je,[(v(!0),b(E,null,O(K.value,o=>(v(),b("div",{key:o.user_id,class:"member-item"},[n("div",Ne,[t(c,{size:40,src:o.avatar_url},{default:a(()=>[i(r(o.username.charAt(0)),1)]),_:2},1032,["src"])]),n("div",Be,[n("div",Te,r(o.username),1),n("div",$e,[t(l,{size:"small",type:X(o.role)},{default:a(()=>[i(r(W(o.role)),1)]),_:2},1032,["type"])])]),n("div",Fe,[n("div",Ie,"加入时间："+r(j(o.joined_at)),1),o.last_active_at?(v(),b("div",Ee," 最后活跃："+r(j(o.last_active_at)),1)):k("",!0)])]))),128))])])]),_:1}),V.value?(v(),N(J,{key:0,label:"加入申请",name:"requests"},{default:a(()=>[n("div",Oe,[n("div",Ge,[e[18]||(e[18]=n("h3",null,"加入申请历史",-1)),t(ue,{modelValue:U.value,"onUpdate:modelValue":e[3]||(e[3]=o=>U.value=o),size:"small"},{default:a(()=>[t(A,{label:"all"},{default:a(()=>[...e[14]||(e[14]=[i("全部",-1)])]),_:1}),t(A,{label:"pending"},{default:a(()=>[...e[15]||(e[15]=[i("待审批",-1)])]),_:1}),t(A,{label:"approved"},{default:a(()=>[...e[16]||(e[16]=[i("已批准",-1)])]),_:1}),t(A,{label:"rejected"},{default:a(()=>[...e[17]||(e[17]=[i("已拒绝",-1)])]),_:1})]),_:1},8,["modelValue"])]),n("div",He,[(v(!0),b(E,null,O(P.value,o=>(v(),b("div",{key:o.request_id,class:"request-item"},[n("div",Ke,[t(c,{size:32,src:o.avatar_url},{default:a(()=>[i(r(o.username.charAt(0)),1)]),_:2},1032,["src"]),n("span",Pe,r(o.username),1)]),n("div",Qe,[o.message?(v(),b("div",We," 申请理由："+r(o.message),1)):k("",!0),n("div",Xe," 申请时间："+r(j(o.created_at)),1),n("div",Ye,[t(l,{type:Z(o.status)},{default:a(()=>[i(r(Y(o.status)),1)]),_:2},1032,["type"]),o.reviewed_at?(v(),b("span",Ze," 审批时间："+r(j(o.reviewed_at)),1)):k("",!0)]),o.review_message?(v(),b("div",es," 审批意见："+r(o.review_message),1)):k("",!0)])]))),128))])])]),_:1})):k("",!0)]),_:1},8,["modelValue"]),t(pe,{modelValue:x.value,"onUpdate:modelValue":e[7]||(e[7]=o=>x.value=o),title:"申请加入群聊",width:"400px"},{footer:a(()=>[t(_,{onClick:e[6]||(e[6]=o=>x.value=!1)},{default:a(()=>[...e[19]||(e[19]=[i("取消",-1)])]),_:1}),t(_,{type:"primary",onClick:re,loading:z.value},{default:a(()=>[...e[20]||(e[20]=[i(" 提交申请 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[n("div",ss,[t(_e,{model:w,"label-width":"80px"},{default:a(()=>[t(me,{label:"申请理由"},{default:a(()=>[t(I,{modelValue:w.message,"onUpdate:modelValue":e[5]||(e[5]=o=>w.message=o),type:"textarea",placeholder:"请输入申请加入的理由（可选）",maxlength:"500",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"])])}}},ns=ve(as,[["__scopeId","data-v-27121e38"]]);export{ns as default};
