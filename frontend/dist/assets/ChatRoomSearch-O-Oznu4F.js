import{_ as Ce,u as Ve,z as xe,j as Re,o as p,c as y,a as c,b as a,w as l,A as Ie,x as De,e as T,p as A,q as _,f as g,r as u,v as Te,i as Q,g as Ae,l as W,B as Ue,h as v,C as Se,F as X,n as Y,d as Z,t as C,D as ze}from"./index-CrPuRJEc.js";const $e={class:"chat-room-search"},Pe={class:"search-header"},Ee={class:"search-form"},Fe={class:"search-results"},Be={key:0,class:"skeleton-container"},Le={key:1,class:"no-results"},Ne={key:2},je={key:0,class:"performance-notice"},Je={class:"room-header"},Me={class:"room-avatar"},qe={class:"room-info"},Ge={class:"room-name"},Oe={class:"room-id"},He={key:0,class:"room-description"},Ke={class:"room-stats"},Qe={class:"member-count"},We={class:"room-actions"},Xe={key:1,class:"pagination"},Ye={key:0,class:"join-room-info"},Ze={class:"room-header"},ea={class:"room-info"},se="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",M=20,aa=200,ta={__name:"ChatRoomSearch",emits:["search-complete","search-error"],setup(la,{emit:ne}){const q=Ae(),I=Ve();let G=null;const i=Q({chatId:"",keyword:""});xe([()=>i.chatId,()=>i.keyword],()=>{G&&clearTimeout(G),G=setTimeout(()=>{(i.chatId||i.keyword)&&(console.log("[防抖搜索] 表单变化触发搜索"),V())},500)});const ee=ne,m=g([]),U=g(!1),h=g(0),x=g(1),L=g(!1),w=g({attemptCount:0,lastError:null,avgLoadTime:0,successCount:0}),S=g(!1),O=g(!1),z=g(),N=g([]),n=Q({name:"",description:"",avatar_url:"",max_members:500,is_public:!0,group_id:null}),re={name:[{required:!0,message:"请输入群聊名称",trigger:"blur"},{min:1,max:100,message:"群聊名称长度不能超过100个字符",trigger:"blur"}]},$=g(!1),H=g(!1),R=g(null),P=Q({message:""}),K=o=>!o||o.length<=4?o:o.replace(/(\d{3})(?=\d)/g,"$1-"),V=async(o=0)=>{var d,k,f,D,j,E,F,B;const e=Date.now();U.value=!0,w.value.attemptCount++;const b=setTimeout(()=>{L.value=!0},aa);console.log("[搜索开始] 参数:",{chatId:i.chatId,keyword:i.keyword,page:x.value,pageSize:M,retryCount:o});try{const r={page:x.value,page_size:M};if(i.chatId)try{const s=await A.chatRooms.searchByChatId(i.chatId);m.value=[s.data],h.value=1}catch(s){if(((d=s.response)==null?void 0:d.status)===404)m.value=[],h.value=0,_.warning("未找到该群聊ID");else throw s}else if(i.keyword){r.keyword=i.keyword,console.log("[API请求] 关键词搜索参数:",r);const s=await A.chatRooms.searchChatRooms(r);console.log("[API响应] 关键词搜索结果:",s),m.value=((k=s.data)==null?void 0:k.chat_rooms)||[],h.value=((f=s.data)==null?void 0:f.total)||0,w.value.successCount++,w.value.lastError=null,console.log("[搜索成功] 结果:",{dataCount:m.value.length,totalCount:h.value,responseData:s.data,loadTime:Date.now()-e+"ms"}),m.value.length===0&&h.value>0&&console.warn("[数据异常] 总计数大于0但实际数据为空"),ee("search-complete",{results:m.value,total:h.value,loadTime:Date.now()-e,stats:w.value})}else{console.log("[API请求] 公开群聊列表参数:",r);const s=await A.chatRooms.searchChatRooms(r);console.log("[API响应] 公开群聊列表结果:",s),m.value=((D=s.data)==null?void 0:D.chat_rooms)||[],h.value=((j=s.data)==null?void 0:j.total)||0}}catch(r){if(m.value=[],h.value=0,r.code==="ECONNABORTED")if(console.error("[网络超时] 错误详情:",r),o<2){_.warning(`搜索超时，正在重试(${o+1}/2)...`),setTimeout(()=>{V(o+1)},1e3);return}else{_.error("搜索超时，请检查网络连接后重试");return}if(r.message.includes("Network Error"))if(console.error("[网络错误] 详细信息:",r),o<2){_.warning(`网络连接失败，正在重试(${o+1}/2)...`),setTimeout(()=>{V(o+1)},1e3);return}else{_.error("网络连接失败，请检查网络设置后重试");return}if(((E=r.response)==null?void 0:E.status)>=500){_.error("服务器繁忙，请稍后再试");return}const s=((B=(F=r.response)==null?void 0:F.data)==null?void 0:B.detail)||r.message;_.error("搜索失败："+s),w.value.lastError=s,ee("search-error",{error:s,stats:w.value,retryCount:o})}finally{clearTimeout(b),L.value=!1,U.value=!1;const r=Date.now()-e;r>3e3&&console.warn(`群聊搜索加载耗时: ${r}ms，建议优化`);const s=w.value.avgLoadTime*(w.value.attemptCount-1)+r;w.value.avgLoadTime=s/w.value.attemptCount}},ue=()=>{i.chatId="",i.keyword="",x.value=1,V()},ie=o=>{x.value=o,V()},de=async()=>{try{const o=await A.groups.getGroups();N.value=[...o.data.created.map(e=>({...e,isCreated:!0})),...o.data.joined.map(e=>({...e,isJoined:!0}))]}catch(o){console.error("获取用户群组失败:",o)}},ce=async()=>{if(!I.isAuthenticated){_.warning("请先登录后再创建群聊"),q.push("/login");return}z.value&&await z.value.validate(async o=>{var e,b;if(o){O.value=!0;try{const d=await A.chatRooms.createChatRoom(n);if(_.success("群聊创建成功！"),_.info(`群聊ID: ${K(d.data.data.chat_id)}`),S.value=!1,ae(),I.isAuthenticated&&!I.user)try{await I.fetchUserInfo()}catch(k){console.error("获取用户信息失败:",k)}V()}catch(d){_.error("创建失败："+(((b=(e=d.response)==null?void 0:e.data)==null?void 0:b.detail)||d.message))}finally{O.value=!1}}})},ae=()=>{n.name="",n.description="",n.avatar_url="",n.max_members=500,n.is_public=!0,n.group_id=null,z.value&&z.value.clearValidate()},te=o=>(I.isAuthenticated,!1),me=o=>{if(!I.isAuthenticated){_.warning("请先登录后再加入群聊"),q.push("/login");return}R.value=o,$.value=!0},pe=async()=>{var o,e;H.value=!0;try{await A.chatRooms.createJoinRequest(R.value.chat_room_id,{message:P.message}),_.success("加入申请已发送，请等待审批"),$.value=!1,P.message=""}catch(b){_.error("申请失败："+(((e=(o=b.response)==null?void 0:o.data)==null?void 0:e.detail)||b.message))}finally{H.value=!1}},_e=o=>{q.push(`/chat-rooms/${o.chat_room_id}`)},ve=()=>{console.log("=== 群聊搜索调试信息 ==="),console.log("当前搜索状态:",{chatId:i.chatId,keyword:i.keyword,loading:U.value,chatRoomsCount:m.value.length,total:h.value,currentPage:x.value}),console.log("加载统计:",w.value),console.log("用户群组:",N.value),console.log("手动触发搜索..."),V().then(()=>{console.log("搜索完成，当前结果:",{chatRoomsCount:m.value.length,total:h.value,results:m.value})})};return Re(async()=>{Promise.all([de(),V()]).catch(o=>{console.error("初始化加载失败:",o)})}),(o,e)=>{const b=u("el-icon"),d=u("el-button"),k=u("el-input"),f=u("el-form-item"),D=u("el-form"),j=u("el-skeleton"),E=u("el-card"),F=u("el-col"),B=u("el-row"),r=u("el-empty"),s=u("el-alert"),le=u("el-avatar"),fe=u("el-tag"),ge=u("el-pagination"),he=u("el-input-number"),ye=u("el-switch"),we=u("el-option"),be=u("el-select"),oe=u("el-dialog"),ke=Te("loading");return p(),y("div",$e,[c("div",Pe,[e[16]||(e[16]=c("h2",null,"搜索群聊",-1)),a(d,{type:"primary",onClick:e[0]||(e[0]=t=>S.value=!0)},{default:l(()=>[a(b,null,{default:l(()=>[a(W(Ue))]),_:1}),e[15]||(e[15]=v(" 创建群聊 ",-1))]),_:1})]),c("div",Ee,[a(D,{inline:!0,onSubmit:Ie(V,["prevent"])},{default:l(()=>[a(f,{label:"群聊ID"},{default:l(()=>[a(k,{modelValue:i.chatId,"onUpdate:modelValue":e[1]||(e[1]=t=>i.chatId=t),placeholder:"输入6-8位群聊ID",maxlength:"8",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),a(f,{label:"关键词"},{default:l(()=>[a(k,{modelValue:i.keyword,"onUpdate:modelValue":e[2]||(e[2]=t=>i.keyword=t),placeholder:"群聊名称或描述",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),a(f,null,{default:l(()=>[a(d,{type:"primary",onClick:V,loading:U.value},{default:l(()=>[a(b,null,{default:l(()=>[a(W(Se))]),_:1}),e[17]||(e[17]=v(" 搜索 ",-1))]),_:1},8,["loading"]),a(d,{onClick:ue},{default:l(()=>[...e[18]||(e[18]=[v("重置",-1)])]),_:1}),a(d,{onClick:ve,type:"info",size:"small"},{default:l(()=>[...e[19]||(e[19]=[v(" 调试搜索 ",-1)])]),_:1})]),_:1})]),_:1})]),De((p(),y("div",Fe,[L.value&&m.value.length===0?(p(),y("div",Be,[a(B,{gutter:20},{default:l(()=>[(p(),y(X,null,Y(8,t=>a(F,{xs:24,sm:12,md:8,lg:6,key:t},{default:l(()=>[a(E,{class:"chat-room-card",shadow:"never"},{body:l(()=>[a(j,{rows:4,animated:""})]),_:1})]),_:1})),64))]),_:1})])):T("",!0),m.value.length===0&&!L.value?(p(),y("div",Le,[a(r,{description:"暂无搜索结果"})])):(p(),y("div",Ne,[m.value.length>100?(p(),y("div",je,[a(s,{title:"数据量较大",type:"info",description:"当前显示 {{ chatRooms.length }} 条群聊，建议使用搜索功能筛选","show-icon":"",closable:!1})])):T("",!0),a(B,{gutter:20},{default:l(()=>[(p(!0),y(X,null,Y(m.value,t=>(p(),Z(F,{xs:24,sm:12,md:8,lg:6,key:t.chat_room_id},{default:l(()=>[a(E,{class:"chat-room-card",shadow:"hover"},{default:l(()=>[c("div",Je,[c("div",Me,[a(le,{size:50,src:t.avatar_url||se},{default:l(()=>{var J;return[v(C(((J=t.name)==null?void 0:J.charAt(0))||"群"),1)]}),_:2},1032,["src"])]),c("div",qe,[c("h3",Ge,C(t.name),1),c("p",Oe,"ID: "+C(K(t.chat_id)),1)])]),t.description?(p(),y("p",He,C(t.description),1)):T("",!0),c("div",Ke,[c("span",Qe,[a(b,null,{default:l(()=>[a(W(ze))]),_:1}),v(" "+C(t.current_members)+"/"+C(t.max_members),1)]),a(fe,{size:"small",type:t.is_public?"success":"warning"},{default:l(()=>[v(C(t.is_public?"公开":"私密"),1)]),_:2},1032,["type"])]),c("div",We,[a(d,{type:"primary",size:"small",onClick:J=>me(t),disabled:te(t)},{default:l(()=>[v(C(te(t)?"已加入":"加入群聊"),1)]),_:2},1032,["onClick","disabled"]),a(d,{size:"small",onClick:J=>_e(t)},{default:l(()=>[...e[20]||(e[20]=[v(" 查看详情 ",-1)])]),_:1},8,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1}),h.value>M?(p(),y("div",Xe,[a(ge,{"current-page":x.value,"onUpdate:currentPage":e[3]||(e[3]=t=>x.value=t),"page-size":M,total:h.value,layout:"prev, pager, next",onCurrentChange:ie},null,8,["current-page","total"])])):T("",!0)]))])),[[ke,U.value]]),a(oe,{modelValue:S.value,"onUpdate:modelValue":e[11]||(e[11]=t=>S.value=t),title:"创建群聊",width:"500px",onClose:ae},{footer:l(()=>[a(d,{onClick:e[10]||(e[10]=t=>S.value=!1)},{default:l(()=>[...e[23]||(e[23]=[v("取消",-1)])]),_:1}),a(d,{type:"primary",onClick:ce,loading:O.value},{default:l(()=>[...e[24]||(e[24]=[v(" 创建 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(D,{model:n,rules:re,ref_key:"createFormRef",ref:z,"label-width":"80px"},{default:l(()=>[a(f,{label:"群聊名称",prop:"name"},{default:l(()=>[a(k,{modelValue:n.name,"onUpdate:modelValue":e[4]||(e[4]=t=>n.name=t),placeholder:"请输入群聊名称",maxlength:"100"},null,8,["modelValue"])]),_:1}),a(f,{label:"群聊描述",prop:"description"},{default:l(()=>[a(k,{modelValue:n.description,"onUpdate:modelValue":e[5]||(e[5]=t=>n.description=t),type:"textarea",placeholder:"请输入群聊描述（可选）",maxlength:"500",rows:3},null,8,["modelValue"])]),_:1}),a(f,{label:"群聊头像",prop:"avatar_url"},{default:l(()=>[a(k,{modelValue:n.avatar_url,"onUpdate:modelValue":e[6]||(e[6]=t=>n.avatar_url=t),placeholder:"头像URL（可选）"},null,8,["modelValue"])]),_:1}),a(f,{label:"最大成员数",prop:"max_members"},{default:l(()=>[a(he,{modelValue:n.max_members,"onUpdate:modelValue":e[7]||(e[7]=t=>n.max_members=t),min:10,max:1e3,step:10},null,8,["modelValue"])]),_:1}),a(f,{label:"是否公开",prop:"is_public"},{default:l(()=>[a(ye,{modelValue:n.is_public,"onUpdate:modelValue":e[8]||(e[8]=t=>n.is_public=t)},null,8,["modelValue"]),e[21]||(e[21]=c("span",{class:"form-tip"},"公开群聊可被搜索到",-1))]),_:1}),N.value.length>0?(p(),Z(f,{key:0,label:"关联群组",prop:"group_id"},{default:l(()=>[a(be,{modelValue:n.group_id,"onUpdate:modelValue":e[9]||(e[9]=t=>n.group_id=t),placeholder:"选择关联的学习群组（可选）"},{default:l(()=>[(p(!0),y(X,null,Y(N.value,t=>(p(),Z(we,{key:t.group_id,label:t.name,value:t.group_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[22]||(e[22]=c("div",{class:"form-tip"},"关联后可同步群组成员",-1))]),_:1})):T("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(oe,{modelValue:$.value,"onUpdate:modelValue":e[14]||(e[14]=t=>$.value=t),title:"加入群聊",width:"400px"},{footer:l(()=>[a(d,{onClick:e[13]||(e[13]=t=>$.value=!1)},{default:l(()=>[...e[25]||(e[25]=[v("取消",-1)])]),_:1}),a(d,{type:"primary",onClick:pe,loading:H.value},{default:l(()=>[...e[26]||(e[26]=[v(" 发送申请 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[R.value?(p(),y("div",Ye,[c("div",Ze,[a(le,{size:40,src:R.value.avatar_url||se},{default:l(()=>[v(C(R.value.name.charAt(0)),1)]),_:1},8,["src"]),c("div",ea,[c("h3",null,C(R.value.name),1),c("p",null,"ID: "+C(K(R.value.chat_id)),1)])]),a(D,{model:P,"label-width":"80px"},{default:l(()=>[a(f,{label:"申请理由",prop:"message"},{default:l(()=>[a(k,{modelValue:P.message,"onUpdate:modelValue":e[12]||(e[12]=t=>P.message=t),type:"textarea",placeholder:"请输入申请加入的理由（可选）",maxlength:"500",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])):T("",!0)]),_:1},8,["modelValue"])])}}},sa=Ce(ta,[["__scopeId","data-v-fe2b93e6"]]);export{sa as default};
