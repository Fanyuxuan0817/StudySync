import{_ as ve,u as fe,j as ge,o as c,c as _,a as l,b as s,w as a,t as n,h as i,d as B,m as V,l as v,f as m,r as d,q as be,g as he,k as J,e as h,F,n as E,i as ye}from"./index-D_A4Kxuy.js";const we={class:"chat-room-detail"},ke={class:"detail-header"},Re={class:"room-info"},Ce={class:"room-avatar"},Ve={class:"room-details"},Me={class:"room-name"},xe={class:"room-id"},je={class:"room-stats"},Se={class:"member-count"},qe={class:"header-actions"},Le={class:"info-section"},Ue={key:0,class:"info-section"},ze={class:"group-info"},Ae={class:"members-section"},De={class:"members-header"},Be={class:"members-list"},Je={class:"member-avatar"},Ne={class:"member-info"},Te={class:"member-name"},Ie={class:"member-role"},$e={class:"member-stats"},Fe={class:"join-time"},Ee={key:0,class:"last-active"},Ge={class:"requests-section"},He={class:"requests-header"},Ke={class:"requests-list"},Oe={class:"request-user"},Pe={class:"username"},Qe={class:"request-content"},We={key:0,class:"request-message"},Xe={class:"request-time"},Ye={class:"request-status"},Ze={key:0,class:"review-time"},et={key:1,class:"review-message"},tt={class:"join-dialog-content"},st="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",at={__name:"ChatRoomDetail",setup(ot){const y=be(),L=he(),G=fe(),H=J(()=>{var t;return(t=G.user)==null?void 0:t.user_id}),N=m(!1),U=m(!1),u=m({}),M=m([]),z=m([]),w=m(!1),k=m(!1),T=m("info"),x=m(""),j=m("all"),R=m(!1),g=ye({message:""}),K=J(()=>x.value?M.value.filter(t=>t.username.toLowerCase().includes(x.value.toLowerCase())):M.value),O=J(()=>j.value==="all"?z.value:z.value.filter(t=>t.status===j.value)),P=t=>{if(!t||t.length<=4)return t;let e="";for(let r=0;r<t.length;r++)r>0&&r%3===0&&(e+="-"),e+=t[r];return e},C=t=>new Date(t).toLocaleString("zh-CN"),Q=t=>({owner:"群主",admin:"管理员",member:"成员"})[t]||t,W=t=>({owner:"danger",admin:"warning",member:"info"})[t]||"info",X=t=>({pending:"待审批",approved:"已批准",rejected:"已拒绝",cancelled:"已取消"})[t]||t,Y=t=>({pending:"warning",approved:"success",rejected:"danger",cancelled:"info"})[t]||"info",Z=()=>{L.back()},ee=t=>{L.push(`/groups/${t}`)},te=()=>{v.info("聊天功能开发中...")},se=async()=>{var t,e;N.value=!0;try{const b=(await V.chatRooms.searchChatRooms({page:1,page_size:1})).data.chat_rooms.find(p=>p.chat_room_id===parseInt(y.params.id));if(!b){v.error("群聊不存在"),L.push("/chat-rooms");return}u.value=b}catch(r){v.error("加载群聊信息失败："+(((e=(t=r.response)==null?void 0:t.data)==null?void 0:e.detail)||r.message))}finally{N.value=!1}},ae=async()=>{var t,e;try{const r=await V.chatRooms.getChatRoomMembers(y.params.id);M.value=r.data.members}catch(r){v.error("加载成员列表失败："+(((e=(t=r.response)==null?void 0:t.data)==null?void 0:e.detail)||r.message))}},oe=async()=>{var t,e;try{const r=await V.chatRooms.getJoinRequests(y.params.id);z.value=r.data}catch(r){v.error("加载申请历史失败："+(((e=(t=r.response)==null?void 0:t.data)==null?void 0:e.detail)||r.message))}},le=async()=>{try{const e=(await V.chatRooms.getChatRoomMembers(y.params.id)).data.members.find(r=>r.user_id===H.value);e?(w.value=!0,k.value=e.role==="owner"||e.role==="admin"):(w.value=!1,k.value=!1)}catch{w.value=!1,k.value=!1,console.log("用户不是群聊成员或群聊不存在")}},ne=async()=>{var t,e;if(!g.message.trim()){v.warning("请输入申请理由");return}U.value=!0;try{await V.chatRooms.createJoinRequest(y.params.id,{message:g.message.trim()}),v.success("加入申请已提交，请等待审批"),R.value=!1,g.message=""}catch(r){v.error("提交申请失败："+(((e=(t=r.response)==null?void 0:t.data)==null?void 0:e.detail)||r.message))}finally{U.value=!1}};return ge(async()=>{await se(),await le(),w.value&&(await ae(),k.value&&await oe())}),(t,e)=>{const r=d("ArrowLeft"),b=d("el-icon"),p=d("el-button"),A=d("el-avatar"),S=d("el-tag"),re=d("User"),f=d("el-descriptions-item"),ie=d("el-descriptions"),I=d("el-card"),D=d("el-tab-pane"),ue=d("Search"),$=d("el-input"),q=d("el-radio-button"),de=d("el-radio-group"),ce=d("el-tabs"),me=d("el-form-item"),_e=d("el-form"),pe=d("el-dialog");return c(),_("div",we,[l("div",ke,[s(p,{type:"text",onClick:Z,class:"back-button"},{default:a(()=>[s(b,null,{default:a(()=>[s(r)]),_:1}),e[8]||(e[8]=i(" 返回 ",-1))]),_:1}),l("div",Re,[l("div",Ce,[s(A,{size:60,src:u.value.avatar_url||st},{default:a(()=>{var o;return[i(n((o=u.value.name)==null?void 0:o.charAt(0)),1)]}),_:1},8,["src"])]),l("div",Ve,[l("h1",Me,n(u.value.name),1),l("p",xe,"群聊ID: "+n(P(u.value.chat_id)),1),l("div",je,[s(S,{size:"small",type:u.value.is_public?"success":"warning"},{default:a(()=>[i(n(u.value.is_public?"公开群聊":"私密群聊"),1)]),_:1},8,["type"]),l("span",Se,[s(b,null,{default:a(()=>[s(re)]),_:1}),i(" "+n(u.value.current_members)+"/"+n(u.value.max_members)+" 成员 ",1)])])])]),l("div",qe,[w.value?(c(),B(p,{key:1,type:"success",onClick:te},{default:a(()=>[...e[10]||(e[10]=[i(" 进入群聊 ",-1)])]),_:1})):(c(),B(p,{key:0,type:"primary",onClick:e[0]||(e[0]=o=>R.value=!0),disabled:u.value.current_members>=u.value.max_members},{default:a(()=>[...e[9]||(e[9]=[i(" 申请加入 ",-1)])]),_:1},8,["disabled"]))])]),s(ce,{modelValue:T.value,"onUpdate:modelValue":e[4]||(e[4]=o=>T.value=o),class:"detail-tabs"},{default:a(()=>[s(D,{label:"群聊信息",name:"info"},{default:a(()=>[s(I,null,{default:a(()=>[l("div",Le,[e[11]||(e[11]=l("h3",null,"基本信息",-1)),s(ie,{column:1,border:""},{default:a(()=>[s(f,{label:"群聊名称"},{default:a(()=>[i(n(u.value.name),1)]),_:1}),s(f,{label:"群聊ID"},{default:a(()=>[i(n(u.value.chat_id),1)]),_:1}),s(f,{label:"群聊描述"},{default:a(()=>[i(n(u.value.description||"暂无描述"),1)]),_:1}),s(f,{label:"创建者"},{default:a(()=>[i(n(u.value.creator_name||"未知"),1)]),_:1}),s(f,{label:"创建时间"},{default:a(()=>[i(n(C(u.value.created_at)),1)]),_:1}),s(f,{label:"最大成员数"},{default:a(()=>[i(n(u.value.max_members),1)]),_:1}),s(f,{label:"是否公开"},{default:a(()=>[s(S,{type:u.value.is_public?"success":"warning"},{default:a(()=>[i(n(u.value.is_public?"公开":"私密"),1)]),_:1},8,["type"])]),_:1})]),_:1})]),u.value.group_info?(c(),_("div",Ue,[e[13]||(e[13]=l("h3",null,"关联的学习群组",-1)),s(I,{shadow:"never"},{default:a(()=>[l("div",ze,[l("h4",null,n(u.value.group_info.name),1),l("p",null,n(u.value.group_info.description),1),s(p,{type:"text",onClick:e[1]||(e[1]=o=>ee(u.value.group_info.group_id))},{default:a(()=>[...e[12]||(e[12]=[i(" 查看群组详情 ",-1)])]),_:1})])]),_:1})])):h("",!0)]),_:1})]),_:1}),s(D,{label:"成员列表",name:"members"},{default:a(()=>[l("div",Ae,[l("div",De,[l("h3",null,"群聊成员 ("+n(M.value.length)+")",1),s($,{modelValue:x.value,"onUpdate:modelValue":e[2]||(e[2]=o=>x.value=o),placeholder:"搜索成员",style:{width:"200px"},clearable:""},{prefix:a(()=>[s(b,null,{default:a(()=>[s(ue)]),_:1})]),_:1},8,["modelValue"])]),l("div",Be,[(c(!0),_(F,null,E(K.value,o=>(c(),_("div",{key:o.user_id,class:"member-item"},[l("div",Je,[s(A,{size:40,src:o.avatar_url},{default:a(()=>[i(n(o.username.charAt(0)),1)]),_:2},1032,["src"])]),l("div",Ne,[l("div",Te,n(o.username),1),l("div",Ie,[s(S,{size:"small",type:W(o.role)},{default:a(()=>[i(n(Q(o.role)),1)]),_:2},1032,["type"])])]),l("div",$e,[l("div",Fe,"加入时间："+n(C(o.joined_at)),1),o.last_active_at?(c(),_("div",Ee," 最后活跃："+n(C(o.last_active_at)),1)):h("",!0)])]))),128))])])]),_:1}),k.value?(c(),B(D,{key:0,label:"加入申请",name:"requests"},{default:a(()=>[l("div",Ge,[l("div",He,[e[18]||(e[18]=l("h3",null,"加入申请历史",-1)),s(de,{modelValue:j.value,"onUpdate:modelValue":e[3]||(e[3]=o=>j.value=o),size:"small"},{default:a(()=>[s(q,{label:"all"},{default:a(()=>[...e[14]||(e[14]=[i("全部",-1)])]),_:1}),s(q,{label:"pending"},{default:a(()=>[...e[15]||(e[15]=[i("待审批",-1)])]),_:1}),s(q,{label:"approved"},{default:a(()=>[...e[16]||(e[16]=[i("已批准",-1)])]),_:1}),s(q,{label:"rejected"},{default:a(()=>[...e[17]||(e[17]=[i("已拒绝",-1)])]),_:1})]),_:1},8,["modelValue"])]),l("div",Ke,[(c(!0),_(F,null,E(O.value,o=>(c(),_("div",{key:o.request_id,class:"request-item"},[l("div",Oe,[s(A,{size:32,src:o.avatar_url},{default:a(()=>[i(n(o.username.charAt(0)),1)]),_:2},1032,["src"]),l("span",Pe,n(o.username),1)]),l("div",Qe,[o.message?(c(),_("div",We," 申请理由："+n(o.message),1)):h("",!0),l("div",Xe," 申请时间："+n(C(o.created_at)),1),l("div",Ye,[s(S,{type:Y(o.status)},{default:a(()=>[i(n(X(o.status)),1)]),_:2},1032,["type"]),o.reviewed_at?(c(),_("span",Ze," 审批时间："+n(C(o.reviewed_at)),1)):h("",!0)]),o.review_message?(c(),_("div",et," 审批意见："+n(o.review_message),1)):h("",!0)])]))),128))])])]),_:1})):h("",!0)]),_:1},8,["modelValue"]),s(pe,{modelValue:R.value,"onUpdate:modelValue":e[7]||(e[7]=o=>R.value=o),title:"申请加入群聊",width:"400px"},{footer:a(()=>[s(p,{onClick:e[6]||(e[6]=o=>R.value=!1)},{default:a(()=>[...e[19]||(e[19]=[i("取消",-1)])]),_:1}),s(p,{type:"primary",onClick:ne,loading:U.value},{default:a(()=>[...e[20]||(e[20]=[i(" 提交申请 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l("div",tt,[s(_e,{model:g,"label-width":"80px"},{default:a(()=>[s(me,{label:"申请理由"},{default:a(()=>[s($,{modelValue:g.message,"onUpdate:modelValue":e[5]||(e[5]=o=>g.message=o),type:"textarea",placeholder:"请输入申请加入的理由（可选）",maxlength:"500",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"])])}}},nt=ve(at,[["__scopeId","data-v-6383996b"]]);export{nt as default};
