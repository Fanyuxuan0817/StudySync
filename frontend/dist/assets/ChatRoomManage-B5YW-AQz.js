import{_ as pe,u as fe,j as he,o as d,c as m,a as l,b as s,w as a,m as M,l as f,f as h,r as c,k as O,g as ge,q as ye,h as r,s as E,F as P,n as Q,d as R,t as u,e as q,v as we,x as be,E as ke,i as Ce}from"./index-BpwqB7Vr.js";const Re={class:"chat-room-manage"},qe={class:"manage-header"},ze={class:"header-actions"},xe={class:"chat-rooms-list"},$e={key:0,class:"empty-state"},Ve={key:1},Me={class:"room-header"},De={class:"room-avatar"},Ae={class:"room-info"},Be={class:"room-name"},Se={class:"room-id"},Te={class:"room-stats"},je={class:"stat-item"},Je={class:"stat-value"},Ne={class:"stat-item"},Ee={class:"room-actions"},Le={class:"chat-rooms-list"},Ue={key:0,class:"empty-state"},Fe={key:1},Ie={class:"room-header"},Ge={class:"room-avatar"},He={class:"room-info"},Ke={class:"room-name"},Oe={class:"room-id"},Pe={class:"room-stats"},Qe={class:"stat-item"},We={class:"stat-value"},Xe={class:"stat-item"},Ye={class:"room-actions"},Ze={class:"requests-list"},et={class:"requests-header"},tt={key:0,class:"empty-state"},st={key:1},at={class:"user-info"},ot={key:0,class:"review-info"},lt={class:"user-info"},nt={class:"user-details"},rt={key:0,class:"request-message"},W="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",it={__name:"ChatRoomManage",setup(dt){const L=ge(),X=fe(),U=O(()=>{var o;return(o=X.user)==null?void 0:o.user_id}),z=h("created"),x=h(!1),D=h(!1),k=h([]),$=h([]),A=h([]),y=h(!1),v=h(null),C=Ce({review_message:""}),Y=o=>({owner:"群主",admin:"管理员",member:"成员"})[o]||o,Z=o=>({owner:"danger",admin:"warning",member:"info"})[o]||"info",B=o=>{if(!o||o.length<=4)return o;let e="";for(let i=0;i<o.length;i++)i>0&&i%3===0&&(e+="-"),e+=o[i];return e},ee=o=>new Date(o).toLocaleString("zh-CN"),te=O(()=>$.value.some(o=>o.role==="owner"||o.role==="admin")),S=async()=>{var o,e;x.value=!0;try{const _=(await M.chatRooms.searchChatRooms({page:1,page_size:100})).data.chat_rooms;k.value=_.filter(n=>n.creator_id===U.value),$.value=_.filter(n=>n.creator_id!==U.value);for(const n of k.value)try{const p=await M.chatRooms.getJoinRequests(n.chat_room_id,{status:"pending"});n.pending_requests=p.data.length||0}catch{n.pending_requests=0}}catch(i){f.error("加载群聊失败："+(((e=(o=i.response)==null?void 0:o.data)==null?void 0:e.detail)||i.message))}finally{x.value=!1}},V=async()=>{var o,e;D.value=!0;try{const i=[];for(const _ of k.value)try{const p=(await M.chatRooms.getJoinRequests(_.chat_room_id)).data.map(w=>({...w,avatar_url:null}));i.push(...p)}catch(n){console.error(`获取群聊 ${_.chat_room_id} 的请求失败:`,n)}A.value=i}catch(i){f.error("加载请求失败："+(((e=(o=i.response)==null?void 0:o.data)==null?void 0:e.detail)||i.message))}finally{D.value=!1}},T=()=>{L.push("/chat-rooms/search")},F=o=>{L.push(`/chat-rooms/${o.chat_room_id}`)},se=o=>{z.value="requests",V()},ae=o=>{f.info("编辑功能开发中...")},oe=o=>{f.info("成员管理功能开发中...")},le=async o=>{var e,i;try{await ke.confirm(`确定要退出群聊 "${o.name}" 吗？`,"确认退出",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),f.success("已退出群聊"),S()}catch(_){_!=="cancel"&&f.error("操作失败："+(((i=(e=_.response)==null?void 0:e.data)==null?void 0:i.detail)||_.message))}},ne=o=>{v.value=o,y.value=!0},re=o=>{v.value=o,y.value=!0},I=async o=>{var e,i;try{if(!v.value)return;const _={approve:o,review_message:C.review_message};await M.chatRooms.reviewJoinRequest(v.value.chat_room_id,v.value.request_id,_),f.success(o?"已批准加入申请":"已拒绝加入申请"),y.value=!1,C.review_message="",v.value=null,V(),S()}catch(_){f.error("审批失败："+(((i=(e=_.response)==null?void 0:e.data)==null?void 0:i.detail)||_.message))}};return he(()=>{S(),z.value==="requests"&&V()}),(o,e)=>{const i=c("Search"),_=c("el-icon"),n=c("el-button"),p=c("el-empty"),w=c("el-avatar"),j=c("el-tag"),ie=c("el-badge"),G=c("el-card"),H=c("el-col"),K=c("el-row"),J=c("el-tab-pane"),b=c("el-table-column"),de=c("el-table"),ue=c("el-tabs"),ce=c("el-input"),_e=c("el-form-item"),me=c("el-form"),ve=c("el-dialog"),N=ye("loading");return d(),m("div",Re,[l("div",qe,[e[7]||(e[7]=l("h2",null,"群聊管理",-1)),l("div",ze,[s(n,{onClick:T},{default:a(()=>[s(_,null,{default:a(()=>[s(i)]),_:1}),e[6]||(e[6]=r(" 搜索群聊 ",-1))]),_:1})])]),s(ue,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=t=>z.value=t),class:"manage-tabs"},{default:a(()=>[s(J,{label:"我创建的群聊",name:"created"},{default:a(()=>[E((d(),m("div",xe,[k.value.length===0?(d(),m("div",$e,[s(p,{description:"暂无创建的群聊"},{default:a(()=>[s(n,{type:"primary",onClick:T},{default:a(()=>[...e[8]||(e[8]=[r("创建群聊",-1)])]),_:1})]),_:1})])):(d(),m("div",Ve,[s(K,{gutter:20},{default:a(()=>[(d(!0),m(P,null,Q(k.value,t=>(d(),R(H,{xs:24,sm:12,md:8,lg:6,key:t.chat_room_id},{default:a(()=>[s(G,{class:"chat-room-card",shadow:"hover"},{default:a(()=>[l("div",Me,[l("div",De,[s(w,{size:50,src:t.avatar_url||W},{default:a(()=>[r(u(t.name.charAt(0)),1)]),_:2},1032,["src"])]),l("div",Ae,[l("h3",Be,u(t.name),1),l("p",Se,"ID: "+u(B(t.chat_id)),1)])]),l("div",Te,[l("div",je,[l("span",Je,u(t.current_members),1),e[9]||(e[9]=l("span",{class:"stat-label"},"成员数",-1))]),l("div",Ne,[s(j,{size:"small",type:t.is_public?"success":"warning"},{default:a(()=>[r(u(t.is_public?"公开":"私密"),1)]),_:2},1032,["type"])])]),l("div",Ee,[s(n,{type:"primary",size:"small",onClick:g=>F(t)},{default:a(()=>[...e[10]||(e[10]=[r(" 进入群聊 ",-1)])]),_:1},8,["onClick"]),t.pending_requests>0?(d(),R(n,{key:0,size:"small",onClick:g=>se(t)},{default:a(()=>[e[11]||(e[11]=r(" 审批申请 ",-1)),s(ie,{value:t.pending_requests,class:"item-badge"},null,8,["value"])]),_:2},1032,["onClick"])):q("",!0),s(n,{size:"small",onClick:g=>ae(t)},{default:a(()=>[...e[12]||(e[12]=[r(" 编辑 ",-1)])]),_:1},8,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1})]))])),[[N,x.value]])]),_:1}),s(J,{label:"我加入的群聊",name:"joined"},{default:a(()=>[E((d(),m("div",Le,[$.value.length===0?(d(),m("div",Ue,[s(p,{description:"暂无加入的群聊"},{default:a(()=>[s(n,{type:"primary",onClick:T},{default:a(()=>[...e[13]||(e[13]=[r("搜索群聊",-1)])]),_:1})]),_:1})])):(d(),m("div",Fe,[s(K,{gutter:20},{default:a(()=>[(d(!0),m(P,null,Q($.value,t=>(d(),R(H,{xs:24,sm:12,md:8,lg:6,key:t.chat_room_id},{default:a(()=>[s(G,{class:"chat-room-card",shadow:"hover"},{default:a(()=>[l("div",Ie,[l("div",Ge,[s(w,{size:50,src:t.avatar_url||W},{default:a(()=>[r(u(t.name.charAt(0)),1)]),_:2},1032,["src"])]),l("div",He,[l("h3",Ke,u(t.name),1),l("p",Oe,"ID: "+u(B(t.chat_id)),1),s(j,{size:"small",type:Z(t.role)},{default:a(()=>[r(u(Y(t.role)),1)]),_:2},1032,["type"])])]),l("div",Pe,[l("div",Qe,[l("span",We,u(t.current_members),1),e[14]||(e[14]=l("span",{class:"stat-label"},"成员数",-1))]),l("div",Xe,[s(j,{size:"small",type:t.is_public?"success":"warning"},{default:a(()=>[r(u(t.is_public?"公开":"私密"),1)]),_:2},1032,["type"])])]),l("div",Ye,[s(n,{type:"primary",size:"small",onClick:g=>F(t)},{default:a(()=>[...e[15]||(e[15]=[r(" 进入群聊 ",-1)])]),_:1},8,["onClick"]),t.role!=="member"?(d(),R(n,{key:0,size:"small",onClick:g=>oe(t)},{default:a(()=>[...e[16]||(e[16]=[r(" 成员管理 ",-1)])]),_:1},8,["onClick"])):q("",!0),s(n,{size:"small",onClick:g=>le(t),type:"danger",plain:""},{default:a(()=>[...e[17]||(e[17]=[r(" 退出群聊 ",-1)])]),_:1},8,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1})]))])),[[N,x.value]])]),_:1}),te.value?(d(),R(J,{key:0,label:"审批管理",name:"requests"},{default:a(()=>[E((d(),m("div",Ze,[l("div",et,[e[19]||(e[19]=l("h3",null,"待审批的加入请求",-1)),s(n,{onClick:V,icon:we(be)},{default:a(()=>[...e[18]||(e[18]=[r("刷新",-1)])]),_:1},8,["icon"])]),A.value.length===0?(d(),m("div",tt,[s(p,{description:"暂无待审批的请求"})])):(d(),m("div",st,[s(de,{data:A.value,style:{width:"100%"}},{default:a(()=>[s(b,{prop:"username",label:"申请人",width:"120"},{default:a(t=>[l("div",at,[s(w,{size:32,src:t.row.avatar_url},{default:a(()=>[r(u(t.row.username.charAt(0)),1)]),_:2},1032,["src"]),l("span",null,u(t.row.username),1)])]),_:1}),s(b,{prop:"chat_room_name",label:"群聊名称",width:"150"}),s(b,{prop:"chat_id",label:"群聊ID",width:"120"},{default:a(t=>[r(u(B(t.row.chat_id)),1)]),_:1}),s(b,{prop:"message",label:"申请理由","show-overflow-tooltip":""}),s(b,{prop:"created_at",label:"申请时间",width:"160"},{default:a(t=>[r(u(ee(t.row.created_at)),1)]),_:1}),s(b,{label:"操作",width:"200",fixed:"right"},{default:a(t=>[s(n,{size:"small",type:"success",onClick:g=>ne(t.row)},{default:a(()=>[...e[20]||(e[20]=[r(" 批准 ",-1)])]),_:1},8,["onClick"]),s(n,{size:"small",type:"danger",onClick:g=>re(t.row)},{default:a(()=>[...e[21]||(e[21]=[r(" 拒绝 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]))])),[[N,D.value]])]),_:1})):q("",!0)]),_:1},8,["modelValue"]),s(ve,{modelValue:y.value,"onUpdate:modelValue":e[5]||(e[5]=t=>y.value=t),title:"审批加入申请",width:"400px"},{footer:a(()=>[s(n,{onClick:e[2]||(e[2]=t=>y.value=!1)},{default:a(()=>[...e[23]||(e[23]=[r("取消",-1)])]),_:1}),s(n,{type:"danger",onClick:e[3]||(e[3]=t=>I(!1))},{default:a(()=>[...e[24]||(e[24]=[r("拒绝",-1)])]),_:1}),s(n,{type:"success",onClick:e[4]||(e[4]=t=>I(!0))},{default:a(()=>[...e[25]||(e[25]=[r("批准",-1)])]),_:1})]),default:a(()=>[v.value?(d(),m("div",ot,[l("div",lt,[s(w,{size:40,src:v.value.avatar_url},{default:a(()=>[r(u(v.value.username.charAt(0)),1)]),_:1},8,["src"]),l("div",nt,[l("h4",null,u(v.value.username),1),l("p",null,"申请加入 "+u(v.value.chat_room_name),1)])]),v.value.message?(d(),m("div",rt,[e[22]||(e[22]=l("label",null,"申请理由：",-1)),l("p",null,u(v.value.message),1)])):q("",!0),s(me,{model:C,"label-width":"80px"},{default:a(()=>[s(_e,{label:"审批意见"},{default:a(()=>[s(ce,{modelValue:C.review_message,"onUpdate:modelValue":e[1]||(e[1]=t=>C.review_message=t),type:"textarea",placeholder:"请输入审批意见（可选）",maxlength:"500",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])):q("",!0)]),_:1},8,["modelValue"])])}}},ct=pe(it,[["__scopeId","data-v-3793ff99"]]);export{ct as default};
