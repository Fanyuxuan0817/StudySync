import{_ as Ve,u as xe,f as r,j as Ce,o as v,c as b,a as l,b as t,w as a,d as k,e as g,q as Me,g as Ge,m as w,r as p,s as S,v as De,h as n,x as Ue,t as u,y as qe,z as Re,A as Ae,i as te}from"./index-D_A4Kxuy.js";import{u as Se}from"./user-Cr4O6Dv3.js";const ze={class:"group-detail-container"},je={class:"group-detail-header"},Fe={class:"header-actions"},Ie={class:"group-info-section"},$e={class:"group-avatar-container"},Be={class:"group-name"},Ne={class:"group-description"},Le={class:"group-stats"},Te={class:"stat-item"},Ee={class:"stat-value"},Oe={class:"stat-value"},Qe={class:"stat-value"},He={class:"group-actions"},Je={class:"group-announcement-section"},Ke={class:"section-title"},Pe={class:"announcement-content"},We={class:"group-members-section"},Xe={class:"section-header"},Ye={class:"section-title"},Ze={key:0},et={key:1,class:"no-members"},tt={class:"dialog-footer"},at={class:"dialog-footer"},lt={key:0,class:"member-detail"},ot={class:"member-avatar"},st={class:"member-name"},nt={class:"member-info-item"},rt={class:"info-value"},ut={class:"member-info-item"},it={class:"info-value"},dt={class:"member-info-item"},ct={class:"info-value"},mt={key:0,class:"member-info-item"},pt={class:"info-value"},vt={key:1,class:"member-info-item"},_t={class:"info-value"},ft={key:1},gt={class:"dialog-footer"},yt={__name:"GroupDetail",setup(bt){const C=Ge(),ae=Me(),z=xe();Se();const E=r(!0),f=r(ae.params.id),d=r({}),j=r([]),M=r([]),F=r(""),P=r(0),W=r(0),I=r(!1),h=r(!1),G=r(!1),D=r(!1),O=r(!1),y=r(!1),c=te({name:"",description:"",daily_checkin_required:!0,announcement:""}),U=te({content:""}),_=r(null),$=r(""),B=r(""),q=r(null),le={name:[{required:!0,message:"请输入群名称",trigger:"blur"},{min:2,max:100,message:"长度在 2 到 100 个字符",trigger:"blur"}]},oe={content:[{max:500,message:"公告内容不能超过 500 个字符",trigger:"blur"}]},Q=r(null),H=r(null),se=()=>{C.back()},X=async()=>{var s;E.value=!0;try{const e=await w.groups.getGroups(),i=[...e.data.data.created,...e.data.data.joined].find(m=>m.group_id==f.value);if(i)d.value=i,I.value=!0,h.value=i.creator_id===((s=z.user)==null?void 0:s.id);else try{const m=await w.groups.getGroupMembers(f.value);d.value={group_id:f.value,name:"未知群组",description:"",member_count:m.data.data.total_members},I.value=!1,h.value=!1}catch(m){console.error("获取群组信息失败:",m),elMessage.error("获取群组信息失败")}await Y(),await ne()}catch(e){console.error("获取群组信息失败:",e),elMessage.error("获取群组信息失败")}finally{E.value=!1}},Y=async()=>{try{const s=await w.groups.getGroupMembers(f.value);j.value=s.data.data.members,M.value=[...j.value]}catch(s){console.error("获取群成员失败:",s),elMessage.error("获取群成员失败")}},ne=async()=>{try{const s=await w.groups.getGroupStats(f.value);P.value=s.data.data.today_checked_in_count,W.value=s.data.data.checkin_rate}catch(s){console.error("获取群组统计数据失败:",s)}},re=()=>{if(!F.value){M.value=[...j.value];return}const s=F.value.toLowerCase();M.value=j.value.filter(e=>e.username.toLowerCase().includes(s))},ue=async()=>{try{await w.groups.joinGroup(f.value),elMessage.success("加入群组成功"),await X()}catch(s){console.error("加入群组失败:",s),elMessage.error("加入群组失败")}},ie=()=>{$.value="退出群组",B.value="确定要退出该群组吗？",q.value=async()=>{try{await w.groups.leaveGroup(f.value),elMessage.success("退出群组成功"),C.push("/groups")}catch(s){console.error("退出群组失败:",s),elMessage.error("退出群组失败")}},y.value=!0},de=()=>{c.name=d.value.name||"",c.description=d.value.description||"",c.daily_checkin_required=d.value.daily_checkin_required!==!1,c.announcement=d.value.announcement||"",G.value=!0},ce=async()=>{if(Q.value)try{await Q.value.validate(),d.value.name=c.name,d.value.description=c.description,d.value.daily_checkin_required=c.daily_checkin_required,d.value.announcement=c.announcement,G.value=!1,elMessage.success("保存设置成功")}catch(s){console.error("保存设置失败:",s),elMessage.error("保存设置失败")}},me=()=>{U.content=d.value.announcement||"",D.value=!0},pe=async()=>{if(H.value)try{await H.value.validate(),d.value.announcement=U.content,D.value=!1,elMessage.success("保存公告成功")}catch(s){console.error("保存公告失败:",s),elMessage.error("保存公告失败")}},ve=s=>{_.value=s,O.value=!0},_e=s=>{$.value="移除成员",B.value="确定要移除该成员吗？",q.value=async()=>{try{await w.groups.removeMember(f.value,s),elMessage.success("移除成员成功"),await Y()}catch(e){console.error("移除成员失败:",e),elMessage.error("移除成员失败")}},y.value=!0},fe=()=>{$.value="解散群组",B.value="确定要解散该群组吗？此操作不可恢复。",q.value=async()=>{try{elMessage.success("解散群组成功"),C.push("/groups")}catch(s){console.error("解散群组失败:",s),elMessage.error("解散群组失败")}},y.value=!0},ge=()=>{q.value&&q.value(),y.value=!1},J=()=>{C.push({path:`/groups/${f.value}/chat`,query:{name:d.value.name}})},N=s=>s?new Date(s).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"";return Ce(async()=>{if(!z.isAuthenticated){C.push("/auth/login");return}z.user||await z.fetchUserInfo(),await X()}),(s,e)=>{const V=p("el-icon"),i=p("el-button"),m=p("el-skeleton-item"),K=p("el-avatar"),R=p("el-input"),x=p("el-table-column"),ye=p("el-tag"),be=p("el-table"),Z=p("el-empty"),ke=p("el-card"),we=p("el-skeleton"),A=p("el-form-item"),he=p("el-checkbox"),ee=p("el-form"),L=p("el-dialog");return v(),b("div",ze,[l("div",je,[t(i,{type:"text",onClick:se,class:"back-button"},{default:a(()=>[t(V,null,{default:a(()=>[t(S(De))]),_:1}),e[13]||(e[13]=n(" 返回 ",-1))]),_:1}),e[15]||(e[15]=l("h1",{class:"page-title"},"群聊详情",-1)),l("div",Fe,[h.value?(v(),k(i,{key:0,type:"text",onClick:de},{default:a(()=>[t(V,null,{default:a(()=>[t(S(Ue))]),_:1}),e[14]||(e[14]=n(" 设置 ",-1))]),_:1})):g("",!0)])]),t(we,{loading:E.value,animated:""},{template:a(()=>[t(m,{variant:"image",style:{width:"100px",height:"100px","border-radius":"50%",margin:"0 auto"}}),t(m,{variant:"h2",style:{width:"60%",margin:"20px auto"}}),t(m,{variant:"p",style:{width:"80%",margin:"0 auto"}}),t(m,{variant:"p",style:{width:"70%",margin:"10px auto"}}),t(m,{variant:"h3",style:{width:"40%",margin:"30px 0 20px"}}),t(m,{variant:"p",style:{width:"100%"}}),t(m,{variant:"p",style:{width:"100%"}}),t(m,{variant:"h3",style:{width:"40%",margin:"30px 0 20px"}}),t(m,{variant:"p",style:{width:"100%"}}),t(m,{variant:"p",style:{width:"100%"}})]),default:a(()=>[l("div",Ie,[l("div",$e,[t(K,{size:100,class:"group-avatar"},{default:a(()=>{var o;return[n(u(((o=d.value.name)==null?void 0:o.charAt(0))||"群"),1)]}),_:1})]),l("h2",Be,u(d.value.name),1),l("p",Ne,u(d.value.description||"暂无描述"),1),l("div",Le,[l("div",Te,[l("span",Ee,u(d.value.member_count||0),1),e[16]||(e[16]=l("span",{class:"stat-label"},"成员",-1))]),l("div",{class:"stat-item",onClick:J,style:{cursor:"pointer"}},[l("span",Oe,u(P.value||0),1),e[17]||(e[17]=l("span",{class:"stat-label"},"今日打卡",-1))]),l("div",{class:"stat-item",onClick:J,style:{cursor:"pointer"}},[l("span",Qe,u(W.value||0)+"%",1),e[18]||(e[18]=l("span",{class:"stat-label"},"打卡率",-1))])]),l("div",He,[I.value?g("",!0):(v(),k(i,{key:0,type:"primary",onClick:ue},{default:a(()=>[...e[19]||(e[19]=[n(" 加入群组 ",-1)])]),_:1})),I.value?(v(),k(i,{key:1,type:"success",onClick:J},{default:a(()=>[...e[20]||(e[20]=[n(" 进入群聊 ",-1)])]),_:1})):h.value?g("",!0):(v(),k(i,{key:2,type:"danger",onClick:ie},{default:a(()=>[...e[21]||(e[21]=[n(" 退出群组 ",-1)])]),_:1}))])]),l("div",Je,[l("h3",Ke,[t(V,null,{default:a(()=>[t(S(qe))]),_:1}),e[22]||(e[22]=n(" 群公告 ",-1))]),l("div",Pe,u(d.value.announcement||"暂无公告"),1),h.value?(v(),k(i,{key:0,type:"text",onClick:me},{default:a(()=>[...e[23]||(e[23]=[n(" 编辑公告 ",-1)])]),_:1})):g("",!0)]),l("div",We,[l("div",Xe,[l("h3",Ye,[t(V,null,{default:a(()=>[t(S(Re))]),_:1}),e[24]||(e[24]=n(" 群成员 ",-1))]),t(R,{modelValue:F.value,"onUpdate:modelValue":e[0]||(e[0]=o=>F.value=o),placeholder:"搜索成员",clearable:"",class:"member-search",onInput:re},{prefix:a(()=>[t(V,null,{default:a(()=>[t(S(Ae))]),_:1})]),_:1},8,["modelValue"])]),t(ke,{"body-style":{padding:"20px"}},{default:a(()=>[M.value.length>0?(v(),b("div",Ze,[t(be,{data:M.value,style:{width:"100%"}},{default:a(()=>[t(x,{label:"头像",width:"80"},{default:a(o=>[t(K,{size:40},{default:a(()=>{var T;return[n(u(((T=o.row.username)==null?void 0:T.charAt(0))||"用"),1)]}),_:2},1024)]),_:1}),t(x,{prop:"username",label:"用户名"},{default:a(o=>[l("div",null,[l("span",null,u(o.row.username),1),o.row.role==="owner"?(v(),k(ye,{key:0,size:"small",type:"primary",class:"role-tag"},{default:a(()=>[...e[25]||(e[25]=[n(" 群主 ",-1)])]),_:1})):g("",!0)])]),_:1}),t(x,{label:"角色",width:"100"},{default:a(o=>[l("span",null,u(o.row.role==="owner"?"群主":"成员"),1)]),_:1}),t(x,{label:"加入时间",width:"180"},{default:a(o=>[l("span",null,u(N(o.row.joined_at)),1)]),_:1}),t(x,{label:"最近打卡",width:"180"},{default:a(o=>[l("span",null,u(o.row.last_checkin_date?N(o.row.last_checkin_date):"未打卡"),1)]),_:1}),t(x,{label:"操作",width:"120"},{default:a(o=>[t(i,{size:"small",onClick:T=>ve(o.row)},{default:a(()=>[...e[26]||(e[26]=[n(" 详情 ",-1)])]),_:1},8,["onClick"]),h.value&&o.row.role!=="owner"?(v(),k(i,{key:0,size:"small",type:"danger",onClick:T=>_e(o.row.user_id)},{default:a(()=>[...e[27]||(e[27]=[n(" 移除 ",-1)])]),_:1},8,["onClick"])):g("",!0)]),_:1})]),_:1},8,["data"])])):(v(),b("div",et,[t(Z,{description:"暂无成员"})]))]),_:1})])]),_:1},8,["loading"]),t(L,{modelValue:G.value,"onUpdate:modelValue":e[6]||(e[6]=o=>G.value=o),title:"群设置",width:"500px"},{footer:a(()=>[l("span",tt,[t(i,{onClick:e[5]||(e[5]=o=>G.value=!1)},{default:a(()=>[...e[29]||(e[29]=[n(" 取消 ",-1)])]),_:1}),t(i,{type:"primary",onClick:ce},{default:a(()=>[...e[30]||(e[30]=[n(" 保存 ",-1)])]),_:1}),t(i,{type:"danger",onClick:fe},{default:a(()=>[...e[31]||(e[31]=[n(" 解散群组 ",-1)])]),_:1})])]),default:a(()=>[t(ee,{model:c,rules:le,ref_key:"settingsFormRef",ref:Q,"label-width":"100px"},{default:a(()=>[t(A,{label:"群名称",prop:"name"},{default:a(()=>[t(R,{modelValue:c.name,"onUpdate:modelValue":e[1]||(e[1]=o=>c.name=o),placeholder:"请输入群名称"},null,8,["modelValue"])]),_:1}),t(A,{label:"群描述",prop:"description"},{default:a(()=>[t(R,{modelValue:c.description,"onUpdate:modelValue":e[2]||(e[2]=o=>c.description=o),type:"textarea",placeholder:"请输入群描述",rows:3},null,8,["modelValue"])]),_:1}),t(A,{label:"每日打卡规则"},{default:a(()=>[t(he,{modelValue:c.daily_checkin_required,"onUpdate:modelValue":e[3]||(e[3]=o=>c.daily_checkin_required=o)},{default:a(()=>[...e[28]||(e[28]=[n(" 每天至少 1 次打卡 ",-1)])]),_:1},8,["modelValue"])]),_:1}),t(A,{label:"群公告"},{default:a(()=>[t(R,{modelValue:c.announcement,"onUpdate:modelValue":e[4]||(e[4]=o=>c.announcement=o),type:"textarea",placeholder:"请输入群公告",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(L,{modelValue:D.value,"onUpdate:modelValue":e[9]||(e[9]=o=>D.value=o),title:"编辑群公告",width:"500px"},{footer:a(()=>[l("span",at,[t(i,{onClick:e[8]||(e[8]=o=>D.value=!1)},{default:a(()=>[...e[32]||(e[32]=[n(" 取消 ",-1)])]),_:1}),t(i,{type:"primary",onClick:pe},{default:a(()=>[...e[33]||(e[33]=[n(" 保存 ",-1)])]),_:1})])]),default:a(()=>[t(ee,{model:U,rules:oe,ref_key:"announcementFormRef",ref:H,"label-width":"100px"},{default:a(()=>[t(A,{label:"公告内容",prop:"content"},{default:a(()=>[t(R,{modelValue:U.content,"onUpdate:modelValue":e[7]||(e[7]=o=>U.content=o),type:"textarea",placeholder:"请输入群公告",rows:5},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(L,{modelValue:O.value,"onUpdate:modelValue":e[10]||(e[10]=o=>O.value=o),title:"成员详情",width:"400px"},{default:a(()=>[_.value?(v(),b("div",lt,[l("div",ot,[t(K,{size:80},{default:a(()=>{var o;return[n(u(((o=_.value.username)==null?void 0:o.charAt(0))||"用"),1)]}),_:1})]),l("h4",st,u(_.value.username),1),l("div",nt,[e[34]||(e[34]=l("span",{class:"info-label"},"角色：",-1)),l("span",rt,u(_.value.role==="owner"?"群主":"成员"),1)]),l("div",ut,[e[35]||(e[35]=l("span",{class:"info-label"},"加入时间：",-1)),l("span",it,u(N(_.value.joined_at)),1)]),l("div",dt,[e[36]||(e[36]=l("span",{class:"info-label"},"最近打卡：",-1)),l("span",ct,u(_.value.last_checkin_date?N(_.value.last_checkin_date):"未打卡"),1)]),_.value.week_checkin_days!==void 0?(v(),b("div",mt,[e[37]||(e[37]=l("span",{class:"info-label"},"本周打卡：",-1)),l("span",pt,u(_.value.week_checkin_days)+" 天",1)])):g("",!0),_.value.avg_hours_per_day!==void 0?(v(),b("div",vt,[e[38]||(e[38]=l("span",{class:"info-label"},"平均时长：",-1)),l("span",_t,u(_.value.avg_hours_per_day)+" 小时/天",1)])):g("",!0)])):(v(),b("div",ft,[t(Z,{description:"暂无成员信息"})]))]),_:1},8,["modelValue"]),t(L,{modelValue:y.value,"onUpdate:modelValue":e[12]||(e[12]=o=>y.value=o),title:$.value,width:"400px"},{footer:a(()=>[l("span",gt,[t(i,{onClick:e[11]||(e[11]=o=>y.value=!1)},{default:a(()=>[...e[39]||(e[39]=[n(" 取消 ",-1)])]),_:1}),t(i,{type:"danger",onClick:ge},{default:a(()=>[...e[40]||(e[40]=[n(" 确认 ",-1)])]),_:1})])]),default:a(()=>[l("p",null,u(B.value),1)]),_:1},8,["modelValue","title"])])}}},ht=Ve(yt,[["__scopeId","data-v-91cddb28"]]);export{ht as default};
