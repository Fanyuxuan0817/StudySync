# ## **📌 群组模块业务逻辑（StudySync）— V1 版**

## **一、模块目标（V1）**

V1 版本的群组模块目标是：

* 支持用户创建学习群组
* 支持用户加入/退出群组
* 支持**人工规则 + 打卡数据展示**
* **不做自动化踢人，不依赖 n8n**

> 👉 **原则：V1 先把“人 + 群 + 打卡”跑通，自动化放到 V2。**

---

## **二、核心数据说明（基于现有表）**

### **1. groups（学习群组）**

关键字段：

* `daily_checkin_required`

  * `true`：该群组**要求成员尽量每日打卡**
  * 👉 **V1 仅作为“提示/规则标识”，不会自动踢人**

* `created_by`

  * 群主（owner）

---

### **2. group_members（群组成员）**

关键字段：

* `last_checkin`

  * 记录最近一次打卡日期
  * 👉 **V1 主要用于：**

    * 展示成员活跃情况
    * 作为 V2 自动化的基础数据

* `role`

  * `owner`：群主
  * `member`：普通成员

---

## **三、V1 核心业务流程**

### **✅ 1️⃣ 创建群组（V1）**

**触发者**：用户（创建者）

**流程：**

1. 用户填写：

   * 群组名称（name）
   * 群组描述（description，可选）
   * 是否要求每日打卡（daily_checkin_required）
2. 系统创建 `groups` 记录：

   * `created_by = 当前用户ID`
   * `created_at = NOW()`
3. 自动在 `group_members` 表插入：

   * `group_id = 新群组ID`
   * `user_id = 创建者ID`
   * `role = 'owner'`
   * `last_checkin = NULL`

**约束：**

* 群组名不能为空，长度 ≤ 100

---

### **✅ 2️⃣ 加入群组（V1）**

**流程：**

1. 用户点击「加入群组」
2. 系统检查是否已是成员
3. 若未加入，则插入：

   ```sql
   INSERT INTO group_members
   (group_id, user_id, role, joined_at, last_checkin)
   VALUES (?, ?, 'member', NOW(), NULL);
   ```

**边界：**

* 已是成员 → 提示“已加入”
* 群组不存在 → 404

---

### **✅ 3️⃣ 退出群组（V1）**

**流程：**

```sql
DELETE FROM group_members
WHERE group_id = ? AND user_id = ?;
```

**特殊规则：**

* 若 `role = 'owner'`：

  * 不能直接退出（可选）
  * 需要：

    * 转让群主，或
    * 解散群组

---

### **✅ 4️⃣ 打卡对群组的影响（V1）**

当用户成功打卡后：

```sql
UPDATE group_members
SET last_checkin = CURRENT_DATE
WHERE group_id = ? AND user_id = ?;
```

👉 **V1 里：**

* `last_checkin` 仅用于：

  * 展示“最近活跃时间”
  * 作为统计数据（不触发自动踢人）

---

## **四、V1 版本：群组可视化（推荐实现）**

建议 V1 提供：

### 📊 个人层面

* 最近一次打卡日期（来自 `last_checkin`）
* 本周打卡天数
* 平均学习时长

### 📈 群组层面

* 当前群成员数
* 今日打卡人数
* 打卡率 = 今日打卡人数 / 群成员数

> 👉 这些数据都**不依赖 n8n**，纯后端 + 数据库就能做。

---

## **五、权限表（V1）**

| 行为    | owner  | member     |
| ----- | ------ | ---------- |
| 创建群组  | ✅      | ❌          |
| 删除群组  | ✅      | ❌          |
| 加入群组  | ❌      | ✅          |
| 退出群组  | ❌（需转让） | ✅          |
| 查看群组  | ✅      | ✅          |
| 被自动踢出 | ❌      | ❌（V1 暂不支持） |

---